<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Teacher Jack's Smart Learning Webapp ( Letter to Lucy (Row Your Boat) )</title>
<script type="module">
	// Firebase SDK Imports
	import * as firebase from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
	import * as auth from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
	import * as firestore from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
	window.firebase = {
		initializeApp: firebase.initializeApp,
		auth: {
			getAuth: auth.getAuth,
			signInAnonymously: auth.signInAnonymously,
			signInWithCustomToken: auth.signInWithCustomToken,
			onAuthStateChanged: auth.onAuthStateChanged,
		},
		firestore: {
			getFirestore: firestore.getFirestore,
			doc: firestore.doc,
			setDoc: firestore.setDoc,
			updateDoc: firestore.updateDoc,
			deleteDoc: firestore.deleteDoc,
			collection: firestore.collection,
			onSnapshot: firestore.onSnapshot,
			getDoc: firestore.getDoc,
			writeBatch: firestore.writeBatch,
			setLogLevel: firestore.setLogLevel,
			// Add other firestore functions as needed
		}
	};
</script>

<style>
/* ìš”ì²­ì‚¬í•­: ì†ê¸€ì”¨ ì—°ìŠµ í°íŠ¸ë¡œ 'Poppins' ì‚¬ìš© */
@import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap');
@import url('https://fonts.googleapis.com/css2?family=Parisienne:wght@400&display=swap');

html, body {
height: 100%;
margin: 0;
}

body {
font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
line-height: 1.6;
background-color: #F3F2EC;
color: #333;
padding: 20px;
padding-bottom: 600px; /* ìµœí•˜ë‹¨ ì—¬ë°± ì¶”ê°€ */
transition: padding 0.3s ease;
user-select: none;
}

h1 {
text-align: center;
color: #1E93AB;
margin-bottom: 20px;
}

/* ìƒë‹¨ ë°” ê³ ì • */
.main-controls {
background-color: #fff;
padding: 15px 20px;
margin: -20px;
margin-bottom: 20px;
box-shadow: 0 2px 4px rgba(0,0,0,0.1);
display: flex;
justify-content: flex-end;
align-items: center;
flex-wrap: wrap;
gap: 10px;
position: sticky;
top: 0;
left: 0;
right: 0;
z-index: 1001;
}

/* 'ë‹¨ì–´í•™ìŠµ' ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.control-btn {
background-color: #1E93AB;
color: white;
border: none;
padding: 8px 16px;
border-radius: 5px;
cursor: pointer;
font-weight: bold;
transition: background-color 0.3s ease;
}

.control-btn-group {
margin-right: auto;
display: flex;
align-items: center;
gap: 10px;
}

.control-btn:hover {
background-color: #1E93AB;
}

.test-type-control {
display: flex;
align-items: center;
gap: 8px;
background-color: #F3F2EC;
padding: 4px 10px;
border-radius: 20px;
}

.test-type-control span {
font-size: 0.9em;
font-weight: bold;
color: #555;
cursor: default;
}

.control-btn.testing {
background-color: #E62727;
animation: blink 1s linear infinite;
}

@keyframes blink {
50% { opacity: 0.6; }
}

.main-controls span {
margin-right: 10px;
font-weight: bold;
color: #555;
/* ì˜¤ë””ì˜¤ í† ê¸€ ìŠ¤ìœ„ì¹˜ì™€ í…ìŠ¤íŠ¸ë¥¼ ì •ë ¬í•˜ê¸° ìœ„í•´ flex ì‚¬ìš© */
display: inline-flex;
align-items: center;
}

/* TTS ê´€ë ¨ í† ê¸€ ìŠ¤íƒ€ì¼ ì œê±° */

.table-header {
display: flex;
align-items: center;
gap: 15px;
margin-top: 40px;
}

.table-header h2 {
margin-top: 0;
margin-bottom: 0;
}

#word-game-score-display, #sentence-game-score-display {
font-weight: bold;
color: #E62727;
background-color: #DCDCDC;
padding: 5px 10px;
border-radius: 15px;
font-size: 0.9em;
}

h2 {
border-bottom: 2px solid #1E93AB;
padding-bottom: 10px;
color: #1E93AB;
margin-top: 40px;
}

table {
width: 100%;
border-collapse: collapse;
margin-bottom: 40px;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
background-color: #ffffff;
}

th, td {
border: 1px solid #DCDCDC;
padding: 12px;
text-align: center;
vertical-align: middle;
transition: background-color 0.3s ease;
}

th {
background-color: #1E93AB;
color: white;
font-weight: bold;
}

tr:nth-child(even) {
background-color: #F3F2EC;
}

/* Style for completed rows */
.row-completed {
background-color: #DCDCDC !important;
}

.row-completed td {
color: #555;
}

/* Style for the sentence the user came from */
.highlight-origin {
background-color: #F3F2EC !important; /* Light yellow highlight */
outline: 2px solid #1E93AB; /* Gold outline */
outline-offset: -2px;
}

/* ìš”ì²­ì‚¬í•­: ë“£ê¸° ì—´ ì²« ë²ˆì§¸ í–‰ ê°•ì¡° */
.highlight-listen-cell {
background-color: #FFEB3B !important; /* Yellow */
}

.font-10 { font-size: 10pt; }
.font-15 { font-size: 25pt; }
.font-30 { font-size: 30pt; }
.color-black { color: #212529; }
.text-hidden { color: transparent !important; background-color: #DCDCDC !important; }

/* When a cell is hidden, hide links inside it too */
.text-hidden a {
color: transparent !important;
}

td[data-label="ëœ»"] {
font-size: 17.5pt;
}

.checkbox-15 {
width: 18px;
height: 18px;
cursor: pointer;
}

.clickable {
cursor: pointer;
user-select: none; /* í…ìŠ¤íŠ¸ ì„ íƒ ë°©ì§€ */
transition: transform 0.2s ease, color 0.2s ease;
}

.clickable:hover {
transform: scale(1.1);
}

/* í´ë¦­ ë°©ì§€ í´ë˜ìŠ¤ */
.no-pointer-events {
pointer-events: none;
opacity: 0.8;
}

.repeat-cell {
/* ê¸°ì¡´ CSSëŠ” ìœ ì§€í•˜ë˜, JSì—ì„œ clickableì„ ì œê±°í•˜ì—¬ ì •ì  í‘œì‹œ */
display: flex;
align-items: center;
justify-content: center;
gap: 8px; /* ë²„íŠ¼ê³¼ ìˆ«ì ì‚¬ì´ ê°„ê²© */
font-size: 1.2em; /* ìˆ«ì í¬ê¸° */
font-weight: bold;
}

/* ë°˜ë³µ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì œê±° (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ) */

a {
text-decoration: none;
color: #1E93AB;
font-weight: bold;
}

a:hover {
text-decoration: underline;
}

#back-btn {
display: none; /* Initially hidden */
position: fixed;
bottom: 20px;
right: 20px;
z-index: 1000;
width: 50px;
height: 50px;
border-radius: 50%;
background-color: #1E93AB;
color: white;
border: none;
font-size: 24px;
cursor: pointer;
box-shadow: 0 4px 8px rgba(0,0,0,0.2);
transition: transform 0.2s ease, background-color 0.2s ease;
}

#back-btn:hover {
background-color: #E62727;
transform: scale(1.1);
}

/* Toggle Switch Styles */
.switch {
position: relative;
display: inline-block;
width: 40px;
height: 20px;
vertical-align: middle;
margin-left: 8px;
}

.switch input {
opacity: 0;
width: 0;
height: 0;
}

.slider {
position: absolute;
cursor: pointer;
top: 0;
left: 0;
right: 0;
bottom: 0;
background-color: #DCDCDC;
transition: .4s;
}

.slider:before {
position: absolute;
content: "";
height: 16px;
width: 16px;
left: 2px;
bottom: 2px;
background-color: white;
transition: .4s;
}

input:checked + .slider {
background-color: #1E93AB;
}

input:checked + .slider:before {
transform: translateX(20px);
}

.slider.round {
border-radius: 20px;
}

.slider.round:before {
border-radius: 50%;
}


/* --- Practice Sections --- */
.practice-section {
margin-top: 60px;
padding: 20px;
background-color: #fff;
border-radius: 8px;
box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.practice-section h2 {
margin-top: 0;
}

.handwriting-paragraph {
line-height: 2.5;
color: #444;
border-bottom: 1px dashed #DCDCDC;
padding-bottom: 20px;
margin-bottom: 20px;
}

#writing-practice-section .handwriting-paragraph {
font-family: 'Poppins', sans-serif;
font-size: 35pt;
}

#cursive-practice-section .handwriting-paragraph {
font-family: 'Parisienne', cursive;
font-size: 40pt; /* Cursive needs more space */
line-height: 2.8;
}

.handwriting-paragraph:last-child {
border-bottom: none;
margin-bottom: 0;
}

/* ì†ê¸€ì”¨ ì—°ìŠµ ì„¹ì…˜ì˜ ë¬¸ì¥ ë²ˆí˜¸(ìœ—ì²¨ì) ë§í¬ ìŠ¤íƒ€ì¼ */
.handwriting-paragraph sup a {
text-decoration: none;
color: #1E93AB;
font-weight: normal;
font-size: 0.7em;
vertical-align: super;
margin-right: 5px;
}


/* Gemini Features Styles (Keep for structure, but delete AI-related content) */
.modal {
display: none;
position: fixed;
z-index: 2000;
left: 0;
top: 0;
width: 100%;
height: 100%;
overflow: auto;
background-color: rgba(0,0,0,0.6);
animation: fadeIn 0.3s;
}

@keyframes fadeIn {
from { opacity: 0; }
to { opacity: 1; }
}

.modal-content {
background-color: #fefefe;
margin: 10% auto;
padding: 25px;
border: 1px solid #888;
width: 90%;
max-width: 600px;
border-radius: 10px;
box-shadow: 0 5px 15px rgba(0,0,0,0.3);
position: relative;
animation: slideIn 0.3s;
}

@keyframes slideIn {
from { transform: translateY(-50px); opacity: 0; }
to { transform: translateY(0); opacity: 1; }
}

.close-btn {
color: #aaa;
float: right;
font-size: 28px;
font-weight: bold;
cursor: pointer;
}

.close-btn:hover,
.close-btn:focus {
color: black;
text-decoration: none;
}

/* --- Game Styles --- */
.game-hidden {
display: none !important;
}

.main-content-hidden {
overflow: hidden;
}

body.main-content-hidden > :not(.game-overlay):not(#pronunciation-quest-overlay) {
display: none;
}

.game-overlay {
position: fixed;
top: 0;
left: 0;
width: 100%;
min-height: 100vh; /* Use min-height to ensure it covers the whole screen */
background-color: #1E93AB;
z-index: 2000;
display: flex;
justify-content: center;
align-items: center;
flex-direction: column;
color: white;
padding: 20px;
box-sizing: border-box;
}

.game-intro-screen {
text-align: center;
}

#intro-text {
font-size: 2.5em;
text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
animation: text-pop-in 1s ease-out;
}

@keyframes text-pop-in {
from { transform: scale(0.5); opacity: 0; }
to { transform: scale(1); opacity: 1; }
}

.game-intro-screen .shark-svg {
/* ìƒì–´ í¬ê¸°ë¥¼ 3ë°°ë¡œ í™•ëŒ€ */
width: 600px;
height: 300px;
animation: swim-across 2.5s ease-in-out;
}

@keyframes swim-across {
from { transform: translateX(-150vw) scaleX(-1); }
50% { transform: translateX(0) scaleX(-1); }
to { transform: translateX(150vw) scaleX(-1); }
}


#game-ui {
width: 100%;
max-width: 800px;
height: 100%; /* Make it fill its parent */
display: flex;
flex-direction: column;
}

.game-header {
display: flex;
justify-content: space-between;
align-items: center;
padding: 10px 0;
font-size: 1.5em;
font-weight: bold;
}

#chase-scene {
position: relative;
width: 100%;
height: 100px;
background: linear-gradient(to bottom, #1E93AB, #E62727);
border-radius: 10px;
overflow: hidden;
margin: 20px 0;
border: 3px solid white;
}

#swimmer, #shark {
position: absolute;
top: 50%;
font-size: 50px;
transition: left 0.5s linear;
}

/* ìˆ˜ì˜í•˜ëŠ” ì‚¬ëŒ ì´ëª¨ì§€ ì¢Œìš° ë°˜ì „ ë° ê¸€ë¡œìš° íš¨ê³¼ */
#swimmer {
left: 75%;
transform: translateY(-50%) scaleX(-1);
animation: swimmer-glow-blink 1.5s infinite alternate;
}

/* ìƒì–´ ê¸€ë¡œìš° ì ë©¸ íš¨ê³¼ */
@keyframes shark-glow-blink {
from { filter: drop-shadow(0 0 5px red) brightness(1); }
to { filter: drop-shadow(0 0 20px red) brightness(1.5); }
}

/* ìˆ˜ì˜í•˜ëŠ” ì‚¬ëŒ ê¸€ë¡œìš° ì ë©¸ íš¨ê³¼ */
@keyframes swimmer-glow-blink {
from { filter: drop-shadow(0 0 5px currentColor); }
to { filter: drop-shadow(0 0 20px currentColor); }
}


#shark {
left: 10%;
transform: translateY(-50%) scaleX(-1);
animation: shark-glow-blink 1.5s infinite alternate;
}

#shark .shark-svg {
width: 120px; height: 60px; animation: none;
}

.shark-body-group {
animation: shark-swim-anim 0.8s infinite ease-in-out;
transform-origin: 100px 50px;
}

@keyframes shark-swim-anim {
0%, 100% { transform: rotate(0deg); }
50% { transform: rotate(2deg); }
}


#game-timer {
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
font-size: 3em;
font-weight: bold;
color: rgba(255, 255, 255, 0.3);
}

.game-question {
font-size: 2.5em;
text-align: center;
margin: 20px 0;
padding: 20px;
background-color: rgba(0,0,0,0.2);
border-radius: 10px;
/* ë°œìŒ í€˜ìŠ¤íŠ¸ UIì˜ ë†’ì´ë¥¼ ì¼ì •í•˜ê²Œ ìœ ì§€í•˜ê¸° ìœ„í•´ ìµœì†Œ ë†’ì´ë¥¼ 120pxë¡œ ì¡°ì • */
min-height: 120px;
display: flex;
justify-content: center;
align-items: center;
flex-grow: 1;
}

#game-answers {
display: grid;
grid-template-columns: repeat(2, 1fr);
gap: 15px;
flex-grow: 1;
}

.answer-option {
background-color: white;
color: #333;
border-radius: 10px;
display: flex;
justify-content: center;
align-items: center;
font-size: 1.5em;
font-weight: bold;
cursor: pointer;
transition: transform 0.2s, background-color 0.2s;
padding: 15px;
text-align: center;
}

.answer-option:hover {
transform: scale(1.05);
}

.answer-option.correct { background-color: #1E93AB !important; color: white; }
.answer-option.incorrect { background-color: #E62727 !important; color: white; }
.answer-option.no-click { pointer-events: none; }


.game-result-screen {
text-align: center;
}

.game-result-screen h2 {
font-size: 3em;
color: #1E93AB;
border: none;
}

.game-result-screen p {
font-size: 1.5em;
}


/* --- Pronunciation Quest Styles (Refactored to be TTS-Free) */
#pronunciation-quest-overlay {
background: linear-gradient(135deg, #1E93AB 0%, #E62727 100%);
}

#king-character {
font-size: 150px;
animation: king-bob 2s infinite ease-in-out;
}

@keyframes king-bob {
0%, 100% { transform: translateY(0); }
50% { transform: translateY(-15px); }
}

#king-dialogue {
background-color: #fff;
color: #333;
padding: 20px;
border-radius: 15px;
font-size: 1.5em;
margin-top: 20px;
max-width: 500px;
position: relative;
box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}

#king-dialogue::after {
content: '';
position: absolute;
top: -15px;
left: 50%;
transform: translateX(-50%);
border-width: 0 15px 15px 15px;
border-style: solid;
border-color: transparent transparent #fff transparent;
}

.quest-btn {
background-color: #1E93AB;
color: #fff;
padding: 15px 30px;
font-size: 1.2em;
border-radius: 30px;
border: none;
cursor: pointer;
font-weight: bold;
margin-top: 20px;
transition: transform 0.2s;
}

.quest-btn:hover {
transform: scale(1.1);
}

#quest-scene {
position: relative;
width: 100%;
min-height: 130px;
margin: 20px 0;
background-image: url('https://www.transparenttextures.com/patterns/dark-forest.png'), linear-gradient(to top, #DCDCDC, #1E93AB);
border-radius: 15px;
overflow: hidden;
}

#guardian, #monster {
position: absolute;
font-size: 75px;
top: 50%;
transform: translateY(-50%);
transition: all 0.5s ease-in-out;
}

#guardian.sparkling {
animation: sparkle 0.5s;
}

@keyframes sparkle {
0%, 100% { text-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #1E93AB; }
50% { text-shadow: 0 0 20px #fff, 0 0 30px #1E93AB, 0 0 40px #1E93AB; }
}

#monster {
left: 80%;
transform: translateY(-50%) scaleX(-1);
}

.attack-effect {
position: absolute;
top: 50%;
font-size: 62.5px;
opacity: 0;
pointer-events: none;
}

#guardian-attack {
left: 25%;
transform: translateY(-50%);
}

#monster-attack {
left: 75%;
transform: translateY(-50%);
}

@keyframes monster-attack-anim {
0% { transform: translate(0, -50%) scale(0.5) scaleX(-1); opacity: 1; }
100% { transform: translate(-250%, -50%) scale(1.5) scaleX(-1); opacity: 0; }
}


/* TTS ê¸°ëŠ¥ ì œê±°ë¡œ ì¸í•´ ë§ˆì´í¬ ë²„íŠ¼ ì—­í•  ë³€ê²½ */
#quest-mic-btn {
width: 100px;
height: 100px;
background-color: #E62727;
border-radius: 50%;
display: flex;
justify-content: center;
align-items: center;
font-size: 60px;
cursor: pointer;
margin: 20px auto;
transition: all 0.2s;
border: 5px solid white;
}

#quest-mic-btn:hover {
background-color: #1E93AB;
}

/* TTS ì• ë‹ˆë©”ì´ì…˜ ìŠ¤íƒ€ì¼ ì œê±° */


#quest-feedback-area {
min-height: 120px;
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
}

#quest-feedback {
font-size: 1.5em;
font-weight: bold;
}

.feedback-success { color: #1E93AB; }
.feedback-fail { color: #E62727; }

#quest-controls {
display: flex;
gap: 20px;
margin-top: 10px;
}

.ox-btn {
width: 70px; height: 70px; border-radius: 50%; font-size: 2em;
}

#quest-correct-btn { background-color: #1E93AB; color: white; }
#quest-incorrect-btn { background-color: #E62727; color: white; }

#quest-message-box {
background-color: rgba(0,0,0,0.4);
padding: 10px 15px;
border-radius: 10px;
font-size: 1.1em;
text-align: center;
margin-bottom: 15px;
border: 2px solid rgba(255,255,255,0.5);
}

/* AI Modal Styles (Quiz/Writing Tip) */
#gemini-modal {
display: none;
position: fixed;
z-index: 2000;
left: 0;
top: 0;
width: 100%;
height: 100%;
overflow: auto;
background-color: rgba(0,0,0,0.6);
}
.loader {
border: 5px solid #DCDCDC;
border-radius: 50%;
border-top: 5px solid #1E93AB;
width: 40px;
height: 40px;
animation: spin 1s linear infinite;
margin: 20px auto;
}
@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}


</style>

</head>

<body>

<h1><span style="font-size: 150%;">Teacher Jack's</span> <br>Smart Learning Webapp <br><small>( Letter to Lucy (Row Your Boat) )</small></h1>

<div class="main-controls">
<div class="control-btn-group">
<button id="home-btn" class="control-btn">ğŸ  í™ˆ</button>
<button id="pronunciation-quest-btn" class="control-btn">ë°œìŒ í€˜ìŠ¤íŠ¸</button>
<button id="sentence-learning-btn" class="control-btn">ë¬¸ì¥í•™ìŠµ</button>
<button id="writing-practice-btn" class="control-btn">ì“°ê¸°í•™ìŠµ</button>

<div class="test-type-control">
<span>í•œê¸€</span>
<label class="switch">
<input type="checkbox" id="test-type-toggle" title="ì‹œí—˜ ì¢…ë¥˜ ì „í™˜ (í•œê¸€/ì˜ì–´)">
<span class="slider round"></span>
</label>
<span>ì˜ì–´</span>
</div>
<button id="test-mode-btn" class="control-btn">ì‹œí—˜ë³´ê¸°</button>
<span id="timer" style="font-weight: bold; margin-left: 10px; color: #E62727; min-width: 50px; text-align: center;"></span>
</div>
<!-- í•™ìŠµ ì‹œê°„ ì¹´ìš´í„°ë¥¼ ìƒë‹¨ ë©”ë‰´ë°”ì— ì¶”ê°€ -->
<span id="learning-timer-display" style="font-weight: bold; color: #1E93AB; min-width: 60px; text-align: right;">00:00</span>
</div>


<div class="table-header">
<h2>ë‹¨ì–´ (Words)</h2>
<div class="test-type-control">
<span>KOR</span>
<label class="switch">
<input type="checkbox" id="word-game-test-type-toggle" title="ê²Œì„ ì¢…ë¥˜ ì „í™˜ (í•œê¸€/ì˜ì–´)">
<span class="slider round"></span>
</label>
<span>ENG</span>
</div>
<button id="word-game-btn" class="control-btn">ë‹¨ì–´ê²Œì„</button>
<span id="word-game-score-display" class="game-hidden"></span>
</div>

<table id="word-table">
<thead>
<tr>
<th class="font-10">ìˆœì„œ</th>
<th class="font-10">ì²´í¬</th>
<th class="font-10">IMAGE</th>
<th class="font-10">ë‹¨ì–´ <label class="switch"><input type="checkbox" id="toggle-word-col"><span class="slider round"></span></label></th>
<th class="font-10">ëœ» <label class="switch"><input type="checkbox" id="toggle-word-meaning-col"><span class="slider round"></span></label></th>
<!-- ìƒˆë¡œ ì¶”ê°€ëœ 'ë“£ê¸°' ì—´ -->
<th class="font-10">ë“£ê¸° ğŸ—£ï¸</th>
<th class="font-10">ë°˜ë³µ <span id="reset-word-repeat" class="clickable" style="font-size: 0.7em;" title="ë°˜ë³µ íšŸìˆ˜ ì´ˆê¸°í™”">â™»ï¸</span></th>
<!-- 'ë¬¸ì¥' ì—´ ì œê±°ë¨ -->
</tr>
</thead>
<tbody>
<!-- Word rows will be inserted here by JavaScript -->
</tbody>
</table>

<div class="table-header">
<h2>ë¬¸ì¥ (Sentences)</h2>
<div class="test-type-control">
<span>KOR</span>
<label class="switch">
<input type="checkbox" id="sentence-game-test-type-toggle" title="ê²Œì„ ì¢…ë¥˜ ì „í™˜ (í•œê¸€/ì˜ì–´)">
<span class="slider round"></span>
</label>
<span>ENG</span>
</div>
<button id="sentence-game-btn" class="control-btn">ë¬¸ì¥ê²Œì„</button>
<span id="sentence-game-score-display" class="game-hidden"></span>
</div>

<table id="sentence-table">
<thead>
<tr>
<th class="font-10">ìˆœì„œ</th>
<th class="font-10">ì²´í¬</th>
<th class="font-10">IMAGE</th>
<th class="font-10">ë¬¸ì¥ <label class="switch"><input type="checkbox" id="toggle-sentence-col"><span class="slider round"></span></label></th>
<th class="font-10">ëœ» <label class="switch"><input type="checkbox" id="toggle-sentence-meaning-col"><span class="slider round"></span></label></th>
<!-- ìƒˆë¡œ ì¶”ê°€ëœ 'ë“£ê¸°' ì—´ -->
<th class="font-10">ë“£ê¸° ğŸ—£ï¸</th>
<th class="font-10">ë°˜ë³µ <span id="reset-sentence-repeat" class="clickable" style="font-size: 0.7em;" title="ë°˜ë³µ íšŸìˆ˜ ì´ˆê¸°í™”">â™»ï¸</span></th>
</tr>
</thead>
<tbody>
<!-- Sentence rows will be inserted here by JavaScript -->
</tbody>
</table>


<!-- ì†ê¸€ì”¨ ì—°ìŠµì„ ìœ„í•œ ì„¹ì…˜ ì¶”ê°€ -->
<section id="writing-practice-section" class="practice-section">
<h2>ì†ê¸€ì”¨ ì—°ìŠµ (Handwriting Practice)Â </h2>
<div id="writing-paragraphs">
<!-- Paragraphs will be inserted here by JS -->
</div>
</section>

<!-- Cursive Practice Section -->
<section id="cursive-practice-section" class="practice-section">
<h2>í•„ê¸°ì²´ì—°ìŠµ (Cursive Practice)</h2>
<div id="cursive-paragraphs">
<!-- Paragraphs will be inserted here by JS -->
</div>
</section>

<!-- 'ëŒì•„ê°€ê¸°' ë²„íŠ¼ -->
<button id="back-btn" title="ë°©ê¸ˆ ë³¸ ë¬¸ì¥ìœ¼ë¡œ ëŒì•„ê°€ê¸°">â†©ï¸</button>


<!-- Word Game Area -->
<div id="game-overlay" class="game-overlay game-hidden">
<div id="game-intro-screen" class="game-intro-screen game-hidden">
<svg id="intro-shark" viewBox="0 0 200 100" class="shark-svg">
<g class="shark-body-group">
<path class="shark-tail" d="M160,50 C190,20 190,80 160,50" fill="#DCDCDC"></path>
<path class="shark-body" d="M20,50 C50,20 150,20 160,50 C150,80 50,80 20,50" fill="#DCDCDC"></path>
<path class="shark-fin" d="M90,22 C100,10 120,10 110,22 L100,50 Z" fill="#DCDCDC"></path>
<path class="shark-belly" d="M25,50 C50,65 140,65 160,50 C140,55 50,55 25,50" fill="#F3F2EC"></path>
</g>
<circle cx="45" cy="45" r="4" fill="#E62727"></circle>
<path d="M30,52 L35,56 L40,52 L45,56 L50,52" stroke="#fff" stroke-width="2" fill="none"></path>
</svg>
<h2 id="intro-text">ìƒì–´ê°€ ë‚˜íƒ€ë‚¬ë‹¤!!!<br>ë„ë§ê°€!!!</h2>
</div>

<div id="game-ui" class="game-ui game-hidden">
<div id="game-header">
<div id="game-score">Score: 0</div>
<button id="exit-game-btn" class="control-btn">ë‚˜ê°€ê¸°</button>
</div>
<div id="game-progress" style="font-size: 30pt; color: #DCDCDC; text-align: center;">1 / 9</div>
<div id="chase-scene">
<div id="swimmer">ğŸŠ</div>
<div id="shark">
<svg viewBox="0 0 200 100" class="shark-svg">
<g class="shark-body-group">
<path class="shark-tail" d="M160,50 C190,20 190,80 160,50" fill="#DCDCDC"></path>
<path class="shark-body" d="M20,50 C50,20 150,20 160,50 C150,80 50,80 20,50" fill="#DCDCDC"></path>
<path class="shark-fin" d="M90,22 C100,10 120,10 110,22 L100,50 Z" fill="#DCDCDC"></path>
<path class="shark-belly" d="M25,50 C50,65 140,65 160,50 C140,55 50,55 25,50" fill="#F3F2EC"></path>
</g>
<circle cx="45" cy="45" r="3" fill="#E62727"></circle>
<path d="M30,52 L35,56 L40,52 L45,56 L50,52" stroke="#fff" stroke-width="1.5" fill="none"></path>
</svg>
</div>
<div id="game-timer">8</div>
</div>
<!-- NEW: ê²Œì„ ëª¨ë“œ ì˜¤ë””ì˜¤ ë²„íŠ¼ -->
<div id="game-controls-audio" style="display: flex; justify-content: center; margin-bottom: 20px;">
    <button id="game-audio-btn" class="control-btn" style="padding: 10px 20px; font-size: 1.2em; display: none;">
        ğŸ”Š ë“£ê¸°
    </button>
</div>
<!-- END NEW -->
<div id="game-question" class="game-question">word</div>
<div id="game-answers">
<div class="answer-option" data-color="red"></div>
<div class="answer-option" data-color="blue"></div>
<div class="answer-option" data-color="yellow"></div>
<div class="answer-option" data-color="green"></div>
</div>
</div>

<div id="game-result-screen" class="game-result-screen game-hidden">
<h2 id="game-result-title">ê²Œì„ ì¢…ë£Œ!</h2>
<p>ìµœì¢… ì ìˆ˜: <span id="final-score">0</span>ì </p>
<button id="return-to-main-btn" class="control-btn">ëŒì•„ê°€ê¸°</button>
</div>
</div>


<!-- Pronunciation Quest Game Area -->
<div id="pronunciation-quest-overlay" class="game-overlay game-hidden">
<div id="quest-king-screen" class="game-intro-screen game-hidden">
<div id="king-character">ğŸ‘‘</div>
<div id="king-dialogue">
<p id="king-speech-bubble"></p>
</div>
<button id="accept-quest-btn" class="quest-btn">í€˜ìŠ¤íŠ¸ ìˆ˜ë½!</button>
</div>

<div id="quest-ui" class="game-ui game-hidden">
<div id="quest-header" class="game-header">
<div id="quest-progress">ì¡ì€ ëª¬ìŠ¤í„° ìˆ˜: 0/6</div>
<button id="exit-quest-btn" class="control-btn">ë‚˜ê°€ê¸°</button>
</div>
<div id="quest-message-box">
ëª¬ìŠ¤í„° ì´ë¦„(ë‹¨ì–´)ì„ ì†Œë¦¬ ë‚´ì–´ ì½ê³ , ì•„ë˜ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŠ¤ìŠ¤ë¡œ ë°œìŒì„ í™•ì¸í•˜ì„¸ìš”.
</div>
<div id="quest-scene">
<div id="guardian">ğŸ§™â€â™‚ï¸</div>
<div id="monster">ğŸ²</div>
<div id="guardian-attack" class="attack-effect">âœ¨</div>
<div id="monster-attack" class="attack-effect">ğŸ’¥</div>
</div>
<div id="quest-word-display" class="game-question">Word</div>
<!-- TTS ê¸°ëŠ¥ ì œê±°ë¡œ ì¸í•´ ì—­í•  ë³€ê²½: ë°œìŒ í™•ì¸ í›„ O/X ë²„íŠ¼ ë…¸ì¶œ -> ì´ì œ ì˜¤ë””ì˜¤ ì¬ìƒ -->
<button id="quest-mic-btn" title="ë‹¨ì–´ ë“£ê¸°">ğŸ”</button>
<div id="quest-feedback-area">
<div id="quest-feedback"></div>
<div id="quest-controls" class="game-hidden">
<!-- O: ë°œìŒ ë§ìŒ, X: ë°œìŒ í‹€ë¦¼ (ìŠ¤ìŠ¤ë¡œ í‰ê°€) -->
<button id="quest-correct-btn" class="quest-btn ox-btn" title="ë°œìŒ ì„±ê³µ (O)">O</button>
<button id="quest-incorrect-btn" class="quest-btn ox-btn" title="ë°œìŒ ì‹¤íŒ¨ (X)">X</button>
</div>
</div>
</div>

<div id="quest-result-screen" class="game-result-screen game-hidden">
<h2 id="quest-result-title">ê²Œì„ ì¢…ë£Œ!</h2>
<p>ìµœì¢… ì ìˆ˜: <span id="final-quest-score">0</span>ì </p>
<button id="return-to-main-from-quest-btn" class="control-btn">ëŒì•„ê°€ê¸°</button>
</div>

<div id="gemini-modal" class="modal">
<div class="modal-content">
<span class="close-btn">Ã—</span>
<div id="modal-content-area">
<!-- AI í€´ì¦ˆ ë˜ëŠ” ë‹¤ë¥¸ ê¸°ëŠ¥ ì˜ì—­ (TTS ì œê±° í›„ êµ¬ì¡°ë§Œ ë‚¨ê¹€) -->
<div id="quiz-container">
<div id="quiz-question"></div>
<ul id="quiz-options" class="quiz-options"></ul>
<div id="quiz-feedback"></div>
</div>
</div>
</div>
</div>


<script>
// ===================================================================================
// ë°ì´í„° ì˜ì—­ (ì—…ë°ì´íŠ¸ë¨)
// ===================================================================================

const sentenceData = [
	{ num: 1, eng: "Dear Lucy,", kor: "ë£¨ì‹œì—ê²Œ,", paragraph: "P1", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/031_Dear_Lucy_31_nonfiction0501letter.mp3" },
	{ num: 2, eng: "It was the best and strangest day I have ever had on the river.", kor: "ì˜¤ëŠ˜ì€ ê°•ì—ì„œ ë³´ë‚¸ ë‚  ì¤‘ ê°€ì¥ ë©‹ì§€ê³  ì´ìƒí•œ í•˜ë£¨ì˜€ì–´.", paragraph: "P1", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/032_It_was_the_best_and_strangest_day_I_have_ever_had_on_the_river_32_nonfiction0501letter.mp3" },
	{ num: 3, eng: "I just have to tell you everything that happened because I still canâ€™t stop smiling about it.", kor: "ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆëŠ”ì§€ ê¼­ ë§í•´ì£¼ê³  ì‹¶ì–´. ì•„ì§ë„ ì›ƒìŒì´ ë©ˆì¶”ì§ˆ ì•Šì•„.", paragraph: "P1", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/033_I_just_have_to_tell_you_everything_that_happened_because_I_still_canâ€™t_stop_smiling_about_it_33_nonfiction0501letter.mp3" },
	{ num: 4, eng: "You know my little rowboat, the one Father painted blue last spring?", kor: "ì•„ë¹ ê°€ ì§€ë‚œë´„ì— íŒŒë€ìƒ‰ìœ¼ë¡œ ì¹ í•´ì¤€ ë‚´ ì¡°ê·¸ë§Œ ë…¸ ì “ëŠ” ë°° ê¸°ì–µë‚˜ì§€?", paragraph: "P1", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/034_You_know_my_little_rowboat_the_one_Father_painted_blue_last_spring_34_nonfiction0501letter.mp3" },
	{ num: 5, eng: "I took it down to the river this morning.", kor: "ì˜¤ëŠ˜ ì•„ì¹¨ ê·¸ê±¸ ê°•ìœ¼ë¡œ ê°€ì ¸ê°”ì–´.", paragraph: "P1", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/035_I_took_it_down_to_the_river_this_morning_35_nonfiction0501letter.mp3" },
	{ num: 6, eng: "The sun was bright, the sky was blue, and the breeze felt soft and warm on my face.", kor: "í–‡ì‚´ì´ ë°ê³  í•˜ëŠ˜ì€ íŒŒë—ê³ , ë°”ëŒì´ ì–¼êµ´ì— ë¶€ë“œëŸ½ê²Œ ë‹¿ì•˜ì–´.", paragraph: "P1", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/036_The_sun_was_bright_the_sky_was_blue_and_the_breeze_felt_soft_and_warm_on_my_face_36_nonfiction0501letter.mp3" },
	{ num: 7, eng: "I thought it would be a quiet ride. I was wrong!", kor: "ì¡°ìš©í•œ ì‹œê°„ì¼ ê±°ë¼ ìƒê°í–ˆëŠ”ë°, ì™„ì „ í‹€ë ¸ì–´!", paragraph: "P1", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/037_I_thought_it_would_be_a_quiet_ride_I_was_wrong_37_nonfiction0501letter.mp3" },
	{ num: 8, eng: "At first, I pushed the boat into the water and started to row all by myself.", kor: "ì²˜ìŒì—ëŠ” ë°°ë¥¼ ë°€ì–´ ë„£ê³  í˜¼ì ë…¸ë¥¼ ì “ê¸° ì‹œì‘í–ˆì–´.", paragraph: "P2", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/038_At_first_I_pushed_the_boat_into_the_water_and_started_to_row_all_by_myself_38_nonfiction0501letter.mp3" },
	{ num: 9, eng: "The water made small ripples, and I sang my favorite song, â€œI row, row, row my boat.â€", kor: "ë¬¼ê²°ì´ ì”ì”í•˜ê²Œ ì¼ì—ˆê³ , ë‚˜ëŠ” â€œë…¸ë¥¼ ì €ì–´ìš”, ì €ì–´ìš”, ì €ì–´ìš”â€ ë…¸ë˜ë¥¼ ë¶ˆë €ì§€.", paragraph: "P2", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/039_The_water_made_small_ripples_and_I_sang_my_favorite_song_I_row_row_row_my_boat_39_nonfiction0501letter.mp3" },
	{ num: 10, eng: "It felt so good to hear the oars dip into the water.", kor: "ë…¸ê°€ ë¬¼ì— ë‹¿ëŠ” ì†Œë¦¬ê°€ ì°¸ ê¸°ë¶„ ì¢‹ì•˜ì–´.", paragraph: "P2", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/040_It_felt_so_good_to_hear_the_oars_dip_into_the_water_40_nonfiction0501letter.mp3" },
	{ num: 11, eng: "Then, out of nowhere, my dog came running along the riverbank, barking like he was calling me.", kor: "ê·¸ëŸ°ë° ê°‘ìê¸° ê°œê°€ ê°•ë‘‘ì„ ë”°ë¼ ë‹¬ë ¤ì˜¤ë©´ì„œ ë§ˆì¹˜ ë‚˜ë¥¼ ë¶€ë¥´ëŠ” ë“¯ì´ ì§–ì—ˆì–´.", paragraph: "P2", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/041_Then_out_of_nowhere_my_dog_came_running_along_the_riverbank_barking_like_he_was_calling_me_41_nonfiction0501letter.mp3" },
	{ num: 12, eng: "Before I could say a word, he jumped right into the boat and licked my face.", kor: "ë‚´ê°€ ë­ë¼ ë§í•˜ê¸°ë„ ì „ì— ë°°ì— ë›°ì–´ë“¤ì–´ ì–¼êµ´ì„ í•¥ì•˜ì–´.", paragraph: "P2", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/042_Before_I_could_say_a_word_he_jumped_right_into_the_boat_and_licked_my_face_42_nonfiction0501letter.mp3" },
	{ num: 13, eng: "I laughed so hard I almost dropped an oar.", kor: "ë„ˆë¬´ ì›ƒê²¨ì„œ ë…¸ë¥¼ ë–¨ì–´ëœ¨ë¦´ ë»”í–ˆì§€.", paragraph: "P2", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/043_I_laughed_so_hard_I_almost_dropped_an_oar_43_nonfiction0501letter.mp3" },
	{ num: 14, eng: "Just when the boat stopped rocking, I saw a furry blur come flying out of a treeâ€”my cat!", kor: "ë°°ê°€ ê²¨ìš° ë©ˆì·„ì„ ë•Œ, ë‚˜ë¬´ì—ì„œ í„¸ë³µìˆ­ì´ ë­”ê°€ê°€ ë‚ ì•„ì™”ì–´â€”ë‚´ ê³ ì–‘ì´ì˜€ì–´!", paragraph: "P3", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/044_Just_when_the_boat_stopped_rocking_I_saw_a_furry_blur_come_flying_out_of_a_treemy_cat_44_nonfiction0501letter.mp3" },
	{ num: 15, eng: "She landed right on my lap and meowed at my dog.", kor: "ê³ ì–‘ì´ëŠ” ë‚´ ë¬´ë¦ ìœ„ì— ë–¨ì–´ì ¸ ê°œë¥¼ ë³´ê³  ì•¼ì˜¹í–ˆì–´.", paragraph: "P3", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/045_She_landed_right_on_my_lap_and_meowed_at_my_dog_45_nonfiction0501letter.mp3" },
	{ num: 16, eng: "For a moment it was chaos, but somehow, everything calmed down again.", kor: "ì ê¹ì€ ì—‰ë§ì´ì—ˆì§€ë§Œ ê¸ˆì„¸ ë‹¤ì‹œ ì¡°ìš©í•´ì¡Œì–´.", paragraph: "P3", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/046_For_a_moment_it_was_chaos_but_somehow_everything_calmed_down_again_46_nonfiction0501letter.mp3" },
	{ num: 17, eng: "The dog lay by my feet, the cat purred in the back, and I began to row once more.", kor: "ê°œëŠ” ë°œ ì˜†ì— ëˆ„ì›Œ ìˆê³ , ê³ ì–‘ì´ëŠ” ë’¤ì—ì„œ ê°€ë¥´ë¦‰ê±°ë ¸ì–´. ë‚œ ë‹¤ì‹œ ë…¸ë¥¼ ì €ì—ˆì§€.", paragraph: "P3", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/047_The_dog_lay_by_my_feet_the_cat_purred_in_the_back_and_I_began_to_row_once_more_47_nonfiction0501letter.mp3" },
	{ num: 18, eng: "The river looked smooth like glass, and I felt peaceful.", kor: "ê°•ë¬¼ì€ ìœ ë¦¬ì²˜ëŸ¼ ì”ì”í–ˆê³ , ë§ˆìŒì€ ê³ ìš”í–ˆì–´.", paragraph: "P3", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/048_The_river_looked_smooth_like_glass_and_I_felt_peaceful_48_nonfiction0501letter.mp3" },
	{ num: 19, eng: "Then, Lucy, guess what happened next?", kor: "ê·¸ëŸ°ë° ë£¨ì‹œ, ê·¸ë‹¤ìŒì— ë¬´ìŠ¨ ì¼ì´ ìˆì—ˆëŠ”ì§€ ì•Œì•„?", paragraph: "P4", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/049_Then_Lucy_guess_what_happened_next_49_nonfiction0501letter.mp3" },
	{ num: 20, eng: "A shadow passed over me. I looked up, and my duck was flying above the boat.", kor: "ë‚´ ìœ„ë¡œ ê·¸ë¦¼ìê°€ ì§€ë‚˜ê°€ê¸¸ë˜ ìœ„ë¥¼ ë³´ë‹ˆ, ë‚´ ì˜¤ë¦¬ê°€ ë°° ìœ„ë¥¼ ë‚ ê³  ìˆì—ˆì–´.", paragraph: "P4", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/050_A_shadow_passed_over_me_I_looked_up_and_my_duck_was_flying_above_the_boat_50_nonfiction0501letter.mp3" },
	{ num: 21, eng: "He quacked twice and landed right on my head!", kor: "ì˜¤ë¦¬ê°€ ë‘ ë²ˆ ê½¥ ìš¸ë”ë‹ˆ ë‚´ ë¨¸ë¦¬ ìœ„ì— ë‚´ë ¤ì•‰ì•˜ì–´!", paragraph: "P4", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/051_He_quacked_twice_and_landed_right_on_my_head_51_nonfiction0501letter.mp3" },
	{ num: 22, eng: "The cat yowled, the dog barked, and I yelled, â€œSit down!â€", kor: "ê³ ì–‘ì´ëŠ” ìš¸ê³ , ê°œëŠ” ì§–ê³ , ë‚˜ëŠ” â€œì•‰ì•„!â€ í•˜ê³  ì†Œë¦¬ì³¤ì–´.", paragraph: "P4", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/052_The_cat_yowled_the_dog_barked_and_I_yelled_Sit_down_52_nonfiction0501letter.mp3" },
	{ num: 23, eng: "I had to push the duck to the front so I could see again.", kor: "ë‹¤ì‹œ ì•ì„ ë³´ë ¤ê³  ì˜¤ë¦¬ë¥¼ ë°° ì•ìª½ìœ¼ë¡œ ë°€ì—ˆì§€.", paragraph: "P4", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/053_I_had_to_push_the_duck_to_the_front_so_I_could_see_again_53_nonfiction0501letter.mp3" },
	{ num: 24, eng: "I thought that would be the end of it, but the boat was starting to feel heavy.", kor: "ì´ì œ ëë‚¬ê² ì§€ ì‹¶ì—ˆëŠ”ë°, ë°°ê°€ ì ì  ë¬´ê±°ì›Œì§€ê¸° ì‹œì‘í–ˆì–´.", paragraph: "P4", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/054_I_thought_that_would_be_the_end_of_it_but_the_boat_was_starting_to_feel_heavy_54_nonfiction0501letter.mp3" },
	{ num: 25, eng: "I was just beginning to enjoy the sunshine when my pig and goat showed up at the riverbank.", kor: "í–‡ì‚´ì„ ì¦ê¸°ê³  ìˆë˜ ìˆœê°„, ë¼ì§€ì™€ ì—¼ì†Œê°€ ê°•ë‘‘ì— ë‚˜íƒ€ë‚¬ì–´.", paragraph: "P5", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/055_I_was_just_beginning_to_enjoy_the_sunshine_when_my_pig_and_goat_showed_up_at_the_riverbank_55_nonfiction0501letter.mp3" },
	{ num: 26, eng: "The pig gave me a look like he wanted a ride, and before I could stop him, he splashed right in.", kor: "ë¼ì§€ê°€ íƒ€ê³  ì‹¶ë‹¤ëŠ” ëˆˆë¹›ì„ ë³´ë‚´ë”ë‹ˆ, ë‚´ê°€ ë§ë¦¬ê¸°ë„ ì „ì— ë¬¼ì— ì²¨ë²™ ë›°ì–´ë“¤ì—ˆì–´.", paragraph: "P5", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/056_The_pig_gave_me_a_look_like_he_wanted_a_ride_and_before_I_could_stop_him_he_splashed_right_in_56_nonfiction0501letter.mp3" },
	{ num: 27, eng: "The water rocked so much that I thought weâ€™d tip over.", kor: "ë¬¼ê²°ì´ ë„ˆë¬´ í”ë“¤ë ¤ì„œ ë°°ê°€ ë’¤ì§‘íˆëŠ” ì¤„ ì•Œì•˜ì–´.", paragraph: "P5", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/057_The_water_rocked_so_much_that_I_thought_weâ€™d_tip_over_57_nonfiction0501letter.mp3" },
	{ num: 28, eng: "I told him to stay under the seat, but thenâ€”can you believe it?â€”the goat jumped in too!", kor: "ë¼ì§€ë”ëŸ¬ ì˜ì ë°‘ì— ìˆìœ¼ë¼ í–ˆëŠ”ë°, ë¯¿ê¸° ì–´ë µê² ì§€ë§Œ ì—¼ì†Œë„ ë›°ì–´ë“¤ì—ˆì–´!", paragraph: "P5", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/058_I_told_him_to_stay_under_the_seat_but_thenâ€”can_you_believe_it?â€”the_goat_jumped_in_too_58_nonfiction0501letter.mp3" },
	{ num: 29, eng: "There we were: me, my dog, my cat, my duck, my pig, and my goat, all in one little boat.", kor: "ë‚˜, ê°œ, ê³ ì–‘ì´, ì˜¤ë¦¬, ë¼ì§€, ì—¼ì†Œê¹Œì§€ í•œ ë°°ì— ìˆì—ˆì§€.", paragraph: "P6", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/059_There_we_were_me_my_dog_my_cat_my_duck_my_pig_and_my_goat_all_in_one_little_boat_59_nonfiction0501letter.mp3" },
	{ num: 30, eng: "The noise was terrible, and water was spilling over the sides.", kor: "ì†ŒìŒì´ ì—„ì²­ë‚¬ê³  ë¬¼ì´ ë°° ì•ˆìœ¼ë¡œ ë„˜ì³¤ì–´.", paragraph: "P6", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/060_The_noise_was_terrible_and_water_was_spilling_over_the_sides_60_nonfiction0501letter.mp3" },
	{ num: 31, eng: "My cat hates water, so she jumped up on my shoulders.", kor: "ê³ ì–‘ì´ëŠ” ë¬¼ì„ ì‹«ì–´í•´ì„œ ë‚´ ì–´ê¹¨ ìœ„ë¡œ ì˜¬ë¼ì™”ì–´.", paragraph: "P6", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/061_My_cat_hates_water_so_she_jumped_up_on_my_shoulders_61_nonfiction0501letter.mp3" },
	{ num: 32, eng: "I shouted, â€œWeâ€™re going to sink!â€", kor: "ë‚˜ëŠ” â€œìš°ë¦¬ ê°€ë¼ì•‰ê² ì–´!â€ í•˜ê³  ì™¸ì³¤ì–´.", paragraph: "P6", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/062_I_shouted_Weâ€™re_going_to_sink_62_nonfiction0501letter.mp3" },
	{ num: 33, eng: "The moment I said that, all the animals jumped overboard and swam to the riverbank.", kor: "ê·¸ ë§ì„ í•˜ìë§ˆì ëª¨ë“  ë™ë¬¼ë“¤ì´ ë¬¼ì— ë›°ì–´ë“¤ì–´ ê°•ë‘‘ìœ¼ë¡œ í—¤ì—„ì³¤ì–´.", paragraph: "P7", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/063_The_moment_I_said_that_all_the_animals_jumped_overboard_and_swam_to_the_riverbank_63_nonfiction0501letter.mp3" },
	{ num: 34, eng: "The boat rose up again, light as a leaf.", kor: "ë°°ëŠ” ë‹¤ì‹œ ìì‚¬ê·€ì²˜ëŸ¼ ê°€ë³ê²Œ ë– ì˜¬ëì–´.", paragraph: "P7", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/064_The_boat_rose_up_again_light_as_a_leaf_64_nonfiction0501letter.mp3" },
	{ num: 35, eng: "I sat there laughing, watching them climb out of the water, dripping wet but happy.", kor: "ë‚˜ëŠ” ì›ƒìœ¼ë©° ì –ì€ ë™ë¬¼ë“¤ì´ ê°•ë‘‘ìœ¼ë¡œ ì˜¬ë¼ì˜¤ëŠ” ê±¸ ë´¤ì–´.", paragraph: "P7", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/065_I_sat_there_laughing_watching_them_climb_out_of_the_water_dripping_wet_but_happy_65_nonfiction0501letter.mp3" },
	{ num: 36, eng: "My cat stayed with me, purring on my shoulder while I started to row again.", kor: "ë‚´ ê³ ì–‘ì´ëŠ” ì–´ê¹¨ ìœ„ì—ì„œ ê°€ë¥´ë¦‰ê±°ë¦¬ë©° ë‚¨ì•„ ìˆì—ˆê³ , ë‚˜ëŠ” ë‹¤ì‹œ ë…¸ë¥¼ ì €ì—ˆì–´.", paragraph: "P7", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/066_My_cat_stayed_with_me_purring_on_my_shoulder_while_I_started_to_row_again_66_nonfiction0501letter.mp3" },
	{ num: 37, eng: "I sang softly, â€œI row, row, row my boat,â€ and the sound of my voice echoed off the trees.", kor: "ë‚˜ëŠ” ë¶€ë“œëŸ½ê²Œ ë…¸ë˜í–ˆì–´. â€œë…¸ë¥¼ ì €ì–´ìš”, ì €ì–´ìš”, ì €ì–´ìš”.â€ ë‚´ ëª©ì†Œë¦¬ê°€ ë‚˜ë¬´ë“¤ ì‚¬ì´ë¡œ ìš¸ë ¸ì–´.", paragraph: "P7", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/067_I_sang_softly_I_row_row_row_my_boat_and_the_sound_of_my_voice_echoed_off_the_trees_67_nonfiction0501letter.mp3" },
	{ num: 38, eng: "But Lucy, thatâ€™s not the part that stayed in my heart.", kor: "ê·¸ëŸ°ë° ë£¨ì‹œ, ë‚´ ë§ˆìŒì— ë‚¨ì€ ê±´ ê·¸ê²Œ ì•„ë‹ˆì•¼.", paragraph: "P8", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/068_But_Lucy_thatâ€™s_not_the_part_that_stayed_in_my_heart_68_nonfiction0501letter.mp3" },
	{ num: 39, eng: "The funny part ended quickly, but what I felt after was different.", kor: "ì›ƒê¸´ ì¼ì€ ê¸ˆë°© ëë‚¬ì§€ë§Œ, ê·¸ ë’¤ì˜ ëŠë‚Œì€ ë‹¬ëì–´.", paragraph: "P8", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/069_The_funny_part_ended_quickly_but_what_I_felt_after_was_different_69_nonfiction0501letter.mp3" },
	{ num: 40, eng: "When the river became quiet again and the only sound was the dip of the oars, I began to think.", kor: "ê°•ì´ ë‹¤ì‹œ ê³ ìš”í•´ì§€ê³  ë…¸ê°€ ë¬¼ì— ë‹¿ëŠ” ì†Œë¦¬ë§Œ ë“¤ë¦¬ì, ìƒê°ì´ ë“¤ì—ˆì–´.", paragraph: "P8", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/070_When_the_river_became_quiet_again_and_the_only_sound_was_the_dip_of_the_oars_I_began_to_think_70_nonfiction0501letter.mp3" },
	{ num: 41, eng: "Maybe life is a lot like rowing a boat.", kor: "ì¸ìƒì€ ë°°ë¥¼ ì “ëŠ” ê²ƒê³¼ ë¹„ìŠ·í•œì§€ë„ ëª°ë¼.", paragraph: "P8", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/071_Maybe_life_is_a_lot_like_rowing_a_boat_71_nonfiction0501letter.mp3" },
	{ num: 42, eng: "You start off alone, and one by one, things jump inâ€”friends, surprises, even a few troubles.", kor: "ì²˜ìŒì—” í˜¼ì ì‹œì‘í•˜ì§€ë§Œ, í•˜ë‚˜ì”© ì¹œêµ¬ë‚˜ ë†€ë¼ìš´ ì¼, ê°€ë”ì€ ê±±ì •ê±°ë¦¬ë„ íƒ€ê²Œ ë˜ì§€.", paragraph: "P8", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/072_You_start_off_alone_and_one_by_one_things_jump_inâ€”friends_surprises_even_a_few_troubles_72_nonfiction0501letter.mp3" },
	{ num: 43, eng: "The boat shakes, you laugh, you fall, but you keep rowing because thatâ€™s what keeps you going forward.", kor: "ë°°ê°€ í”ë“¤ë¦¬ê³  ì›ƒë‹¤ê°€ ë„˜ì–´ì ¸ë„, ì•ìœ¼ë¡œ ë‚˜ì•„ê°€ë ¤ë©´ ê³„ì† ë…¸ë¥¼ ì “ëŠ” ê±°ì•¼.", paragraph: "P8", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/073_The_boat_shakes_you_laugh_you_fall_but_you_keep_rowing_because_thatâ€™s_what_keeps_you_going_forward_73_nonfiction0501letter.mp3" },
	{ num: 44, eng: "I think about how beautiful everything looked: the sunlight on the water, the smell of the trees, the way the air moved.", kor: "ëª¨ë“  ê²Œ ì–¼ë§ˆë‚˜ ì•„ë¦„ë‹¤ì› ëŠ”ì§€ ìƒê°ë‚¬ì–´. í–‡ì‚´, ë‚˜ë¬´ ëƒ„ìƒˆ, ë°”ëŒì˜ ì›€ì§ì„ê¹Œì§€.", paragraph: "P9", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/074_I_think_about_how_beautiful_everything_looked_the_sunlight_on_the_water_the_smell_of_the_trees_the_way_the_air_moved_74_nonfiction0501letter.mp3" },
	{ num: 45, eng: "It felt like the world was smiling at me.", kor: "ì„¸ìƒì´ ë‚˜ì—ê²Œ ì›ƒê³  ìˆëŠ” ê²ƒ ê°™ì•˜ì–´.", paragraph: "P9", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/075_It_felt_like_the_world_was_smiling_at_me_75_nonfiction0501letter.mp3" },
	{ num: 46, eng: "For a while, I forgot everything else.", kor: "ì ì‹œ ë™ì•ˆì€ ë‹¤ë¥¸ ëª¨ë“  ê±¸ ìŠì—ˆì–´.", paragraph: "P9", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/076_For_a_while_I_forgot_everything_else_76_nonfiction0501letter.mp3" },
	{ num: 47, eng: "I didnâ€™t worry about school or chores or even muddy paws on my clothes.", kor: "í•™êµ ì¼ì´ë‚˜ ì§‘ì•ˆì¼, ì˜·ì— ë¬»ì€ ë°œìêµ­ë„ ì‹ ê²½ ì“°ì´ì§€ ì•Šì•˜ì–´.", paragraph: "P9", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/077_I_didnâ€™t_worry_about_school_or_chores_or_even_muddy_paws_on_my_clothes_77_nonfiction0501letter.mp3" },
	{ num: 48, eng: "I just felt happy to be part of something so alive.", kor: "ì‚´ì•„ ìˆëŠ” ì„¸ìƒì˜ í•œ ë¶€ë¶„ì´ë¼ëŠ” ê²Œ ê·¸ì € í–‰ë³µí–ˆì–´.", paragraph: "P9", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/078_I_just_felt_happy_to_be_part_of_something_so_alive_78_nonfiction0501letter.mp3" },
	{ num: 49, eng: "Lucy, when you visit next time, letâ€™s go to the river together.", kor: "ë£¨ì‹œ, ë‹¤ìŒì— ë†€ëŸ¬ì˜¤ë©´ ìš°ë¦¬ ê°™ì´ ê°•ìœ¼ë¡œ ê°€ì.", paragraph: "P10", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/079_Lucy_when_you_visit_next_time_letâ€™s_go_to_the_river_together_79_nonfiction0501letter.mp3" },
	{ num: 50, eng: "Iâ€™ll take you in my rowboat.", kor: "ë‚´ ë…¸ ì “ëŠ” ë°°ì— íƒœì›Œì¤„ê²Œ.", paragraph: "P10", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/080_Iâ€™ll_take_you_in_my_rowboat_80_nonfiction0501letter.mp3" },
	{ num: 51, eng: "We can bring sandwiches and lemonade.", kor: "ìƒŒë“œìœ„ì¹˜ë‘ ë ˆëª¨ë„¤ì´ë“œë¥¼ ì±™ê²¨ ê°€ì.", paragraph: "P10", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/081_We_can_bring_sandwiches_and_lemonade_81_nonfiction0501letter.mp3" },
	{ num: 52, eng: "Maybe the animals will follow again, or maybe theyâ€™ll just watch from the riverbank.", kor: "ì•„ë§ˆ ë™ë¬¼ë“¤ì´ ë˜ ë”°ë¼ì˜¤ê±°ë‚˜, ê°•ë‘‘ì—ì„œ êµ¬ê²½ë§Œ í• ì§€ë„ ëª°ë¼.", paragraph: "P10", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/082_Maybe_the_animals_will_follow_again_or_maybe_theyâ€™ll_just_watch_from_the_riverbank_82_nonfiction0501letter.mp3" },
	{ num: 53, eng: "Either way, I want you to feel what I feltâ€”the peace, the laughter, and the little bit of magic that hides in a summer day.", kor: "ì–´ì¨Œë“  ë„¤ê°€ ë‚´ê°€ ëŠê¼ˆë˜ ê±¸ ëŠê¼ˆìœ¼ë©´ ì¢‹ê² ì–´â€”í‰í™”, ì›ƒìŒ, ê·¸ë¦¬ê³  ì—¬ë¦„ë‚ ì˜ ì‘ì€ ë§ˆë²•ì„.", paragraph: "P10", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/083_Either_way_I_want_you_to_feel_what_I_feltâ€”the_peace_the_laughter_and_the_little_bit_of_magic_that_hides_in_a_summer_day_83_nonfiction0501letter.mp3" },
	{ num: 54, eng: "Your friend always,", kor: "ì–¸ì œë‚˜ ë„¤ ì¹œêµ¬,", paragraph: "P11", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/084_Your_friend_always_84_nonfiction0501letter.mp3" },
	{ num: 55, eng: "Will", kor: "ìœŒì´ ë“œë¦¼", paragraph: "P11", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/085_Will_85_nonfiction0501letter.mp3" }
];

const wordData = [
	{ num: 1, eng: "overboard", kor: "ë¬¼ë°–ìœ¼ë¡œ, ë°° ë°–ìœ¼ë¡œ", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/001_overboard_1_nonfiction0501letter.mp3" },
	{ num: 2, eng: "riverbank", kor: "ê°•ë‘‘", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/002_riverbank_2_nonfiction0501letter.mp3" },
	{ num: 3, eng: "rowboat", kor: "ë…¸ ì “ëŠ” ë°°", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/003_rowboat_3_nonfiction0501letter.mp3" },
	{ num: 4, eng: "ripples", kor: "ì”ë¬¼ê²°", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/004_ripples_4_nonfiction0501letter.mp3" },
	{ num: 5, eng: "breeze", kor: "ì‚°ë“¤ë°”ëŒ", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/005_breeze_5_nonfiction0501letter.mp3" },
	{ num: 6, eng: "peaceful", kor: "í‰í™”ë¡œìš´", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/006_peaceful_6_nonfiction0501letter.mp3" },
	{ num: 7, eng: "quacked", kor: "(ì˜¤ë¦¬ê°€) ê½¥ê½¥ ìš¸ì—ˆë‹¤", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/007_quacked_7_nonfiction0501letter.mp3" },
	{ num: 8, eng: "yowled", kor: "(ê³ ì–‘ì´ê°€) ìš¸ë¶€ì§–ì—ˆë‹¤", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/008_yowled_8_nonfiction0501letter.mp3" },
	{ num: 9, eng: "purr", kor: "(ê³ ì–‘ì´ê°€) ê°€ë¥´ë¦‰ê±°ë¦¬ë‹¤", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/009_purr_9_nonfiction0501letter.mp3" },
	{ num: 10, eng: "splashed", kor: "ì²¨ë²™ê±°ë ¸ë‹¤", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/010_splashed_10_nonfiction0501letter.mp3" },
	{ num: 11, eng: "tipped over", kor: "ë’¤ì§‘í˜”ë‹¤", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/011_tipped_over_11_nonfiction0501letter.mp3" },
	{ num: 12, eng: "chaos", kor: "í˜¼ë€", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/012_chaos_12_nonfiction0501letter.mp3" },
	{ num: 13, eng: "echoed", kor: "ë©”ì•„ë¦¬ì³¤ë‹¤", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/013_echoed_13_nonfiction0501letter.mp3" },
	{ num: 14, eng: "suddenly", kor: "ê°‘ìê¸°", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/014_suddenly_14_nonfiction0501letter.mp3" },
	{ num: 15, eng: "shouted", kor: "ì™¸ì³¤ë‹¤", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/015_shouted_15_nonfiction0501letter.mp3" },
	{ num: 16, eng: "sank", kor: "ê°€ë¼ì•‰ì•˜ë‹¤", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/016_sank_16_nonfiction0501letter.mp3" },
	{ num: 17, eng: "steady", kor: "ì•ˆì •ëœ", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/017_steady_17_nonfiction0501letter.mp3" },
	{ num: 18, eng: "smooth", kor: "ì”ì”í•œ", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/018_smooth_18_nonfiction0501letter.mp3" },
	{ num: 19, eng: "heavy", kor: "ë¬´ê±°ìš´", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/019_heavy_19_nonfiction0501letter.mp3" },
	{ num: 20, eng: "shook", kor: "í”ë“¤ë ¸ë‹¤", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/020_shook_20_nonfiction0501letter.mp3" },
	{ num: 21, eng: "nodded", kor: "ê³ ê°œë¥¼ ë„ë•ì˜€ë‹¤", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/021_nodded_21_nonfiction0501letter.mp3" },
	{ num: 22, eng: "leafy", kor: "ë‚˜ë­‡ìì´ ë¬´ì„±í•œ", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/022_leafy_22_nonfiction0501letter.mp3" },
	{ num: 23, eng: "whispered", kor: "ì†ì‚­ì˜€ë‹¤", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/023_whispered_23_nonfiction0501letter.mp3" },
	{ num: 24, eng: "laughter", kor: "ì›ƒìŒ", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/024_laughter_24_nonfiction0501letter.mp3" },
	{ num: 25, eng: "troubles", kor: "ê±±ì •ê±°ë¦¬, ë¬¸ì œë“¤", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/025_troubles_25_nonfiction0501letter.mp3" },
	{ num: 26, eng: "peacefulness", kor: "ê³ ìš”í•¨", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/026_peacefulness_26_nonfiction0501letter.mp3" },
	{ num: 27, eng: "magic", kor: "ë§ˆë²•", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/027_magic_27_nonfiction0501letter.mp3" },
	{ num: 28, eng: "sunlight", kor: "í–‡ì‚´", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/028_sunlight_28_nonfiction0501letter.mp3" },
	{ num: 29, eng: "lemonade", kor: "ë ˆëª¨ë„¤ì´ë“œ", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/029_lemonade_29_nonfiction0501letter.mp3" },
	{ num: 30, eng: "forward", kor: "ì•ìœ¼ë¡œ, ì „ì§„í•˜ì—¬", audioUrl: "https://github.com/Steven-ssem/nonfiction0501letter/raw/refs/heads/main/030_forward_30_nonfiction0501letter.mp3" }
];


// ===================================================================================
// Firebase & Global State Management
// ===================================================================================

// Global variables provided by the Canvas environment
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

let db;
let auth;
let userId = null;
let isAuthReady = false;

// Local state to store Firestore data (Progress and Scores)
let learningProgress = {}; // { 'word-1': { checked: true, repeat: 5 }, ... }
let gameScores = { word: '0', sentence: '0', quest: '0' }; 

let lastActiveSentenceId = null;
let lastScrollY = null;
let lastWritingPracticeY = null;

// ì˜¤ë””ì˜¤ ìºì‹œ ì¶”ê°€: MP3 íŒŒì¼ URLì„ í‚¤ë¡œ ì‚¬ìš©
const audioCache = {};

// Test Mode State
let isTestMode = false;
let timerInterval = null;
let secondsElapsed = 0;

// Game State
let currentGameTimeLimit = 8;
let gameTimerInterval = null;
let gameTimeLeft = 0;
let currentGameScore = 0;
let currentQuestionIndex = 0;
let shuffledData = [];
let consecutiveWrongAnswers = 0;
let swimmerPosition = 0;
let sharkPosition = 0;
let currentGameType = 'word';
let isEngTestMode = false;
let incorrectQueue = [];
let difficultyPool = [];
let difficultyPoolIndex = 0;
let totalQuestionsTarget = 30;

// Pronunciation Quest State
const monsters = ['ğŸ²', 'ğŸ‘¹', 'ğŸ‘»', 'ğŸ‘½', 'ğŸ‘¿', 'ğŸƒ', 'ğŸ¤¡', 'ğŸ¤–', 'ğŸ‘¾', 'ğŸ¸'];
let questWords = [];
let questQuestionCount = 0;
let monstersCaught = 0;
let questScore = 0;

// í•™ìŠµ ì‹œê°„ ì¹´ìš´í„° ê´€ë ¨ ë³€ìˆ˜
let learningTimerInterval = null;
let learningSecondsElapsed = 0;
let inactivityTimeout = null;
const inactivityDuration = 20000; // 20ì´ˆ (20000ms)

// Word Lookup Map (for efficient and accurate linking)
let wordLookupMap = new Map();


// ===================================================================================
// Firebase Initialization & Persistence Functions
// ===================================================================================

async function initializeFirebase() {
	if (!window.firebase || !firebaseConfig) { 
		console.error("Firebase SDK or config not found. Skipping persistence setup.");
		isAuthReady = true;
		updateUIFromState(); // Run update with default state
		return;
	}
	
	const { initializeApp, auth: fAuth, firestore: fFirestore } = window.firebase;
	
	const app = initializeApp(firebaseConfig);
	db = fFirestore.getFirestore(app);
	auth = fAuth.getAuth(app);
	
	fFirestore.setLogLevel('debug');

	// ì¸ì¦ (Authentication)
	try {
		if (initialAuthToken) {
			await fAuth.signInWithCustomToken(auth, initialAuthToken);
		} else {
			await fAuth.signInAnonymously(auth);
		}
	} catch (error) {
		console.error("Firebase Auth Error:", error);
	}
	
	fAuth.onAuthStateChanged(auth, (user) => {
		// ê° ì¥ì¹˜/ì‚¬ìš©ìë³„ ë°ì´í„° ë…ë¦½ì„± ë³´ì¥:
		// FirestoreëŠ” ê³ ìœ í•œ ì‚¬ìš©ì ID(user.uid)ë¥¼ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ì½ìŠµë‹ˆë‹¤.
		// ê° íƒœë¸”ë¦¿ì€ ê³ ìœ í•œ ì„¸ì…˜ì„ ê°€ì§€ë¯€ë¡œ, ì„œë¡œì˜ ë°ì´í„°ì— ì˜í–¥ì„ ì£¼ì§€ ì•ŠìŠµë‹ˆë‹¤.
		userId = user ? user.uid : 'anonymous-user-' + crypto.randomUUID();
		document.getElementById('learning-timer-display').title = `User ID: ${userId}`;
		fetchProgressAndScores();
		isAuthReady = true;
	});
}

/**
 * Firestoreì—ì„œ í•™ìŠµ ì§„í–‰ ìƒí™© ë° ì ìˆ˜ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
 *
 * NOTE: FIRESTORE (11.6.1) INTERNAL ASSERTION FAILED ì˜¤ë¥˜ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´
 * snapshot.docChanges() ëŒ€ì‹  snapshot.docsë¥¼ ì‚¬ìš©í•˜ì—¬ ë§¤ë²ˆ ì „ì²´ ìƒíƒœë¥¼ ì¬êµ¬ì¶•í•©ë‹ˆë‹¤.
 */
function fetchProgressAndScores() {
	if (!db || !userId) return;

	const { collection, onSnapshot, doc } = window.firebase.firestore;

	// 1. Fetch Learning Progress (Checkboxes and Repeats)
	// Path: /artifacts/{appId}/users/{userId}/progress
	const progressColRef = collection(db, 'artifacts', appId, 'users', userId, 'progress');
	onSnapshot(progressColRef, (snapshot) => {
		// Fix: Use snapshot.docs to robustly rebuild the state on every update,
		// which helps avoid internal assertion errors related to change application.
		const newProgress = {};
		snapshot.docs.forEach(doc => {
			newProgress[doc.id] = doc.data();
		});
		learningProgress = newProgress;
		updateUIFromState();
	}, (error) => {
		console.error("Error fetching progress:", error);
	});

	// 2. Fetch Game Scores (Using a single document for simplicity)
	// Path: /artifacts/{appId}/users/{userId}/scores/game_scores
	const scoreDocRef = doc(db, 'artifacts', appId, 'users', userId, 'scores', 'game_scores');
	onSnapshot(scoreDocRef, (docSnap) => {
		if (docSnap.exists()) {
			gameScores = { ...gameScores, ...docSnap.data() };
		}
		updateScoreDisplays();
	}, (error) => {
		console.error("Error fetching scores:", error);
	});
}

/**
 * Firestoreì— í•™ìŠµ ì§„í–‰ ìƒí™©ì„ ì €ì¥í•©ë‹ˆë‹¤.
 * @param {string} id 'word-1' ë˜ëŠ” 'sentence-5'
 * @param {object} data ì €ì¥í•  ë°ì´í„° ({ checked: boolean, repeat: number })
 */
async function saveLearningProgress(id, data) {
	if (!db || !userId) return;
	const { doc, setDoc } = window.firebase.firestore;
	try {
		const docRef = doc(db, 'artifacts', appId, 'users', userId, 'progress', id);
		await setDoc(docRef, data, { merge: true });
	} catch (error) {
		console.error("Error saving progress:", id, error);
	}
}

/**
 * Firestoreì— ê²Œì„ ì ìˆ˜ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.
 * @param {string} gameType 'word', 'sentence', or 'quest'
 * @param {number} score 
 */
async function saveGameScore(gameType, score) {
	if (!db || !userId) return;
	const { doc, setDoc } = window.firebase.firestore;
	try {
		const docRef = doc(db, 'artifacts', appId, 'users', userId, 'scores', 'game_scores');
		await setDoc(docRef, { [gameType]: String(score) }, { merge: true });
	} catch (error) {
		console.error("Error saving game score:", gameType, error);
	}
}


/**
 * Firestore ë°ì´í„° ë³€ê²½ ì‹œ UIë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
 */
function updateUIFromState() {
	if (!isAuthReady) return; // Wait until auth/fetch has at least started

	// Update tables
	['word-table', 'sentence-table'].forEach(tableId => {
		const rows = document.querySelectorAll(`#${tableId} tbody tr`);
		rows.forEach(row => {
			const rowId = row.id;
			const state = learningProgress[rowId] || { checked: false, repeat: 0 };
			
			// 1. Checkbox and Completion
			const mainCheckbox = row.querySelector('.main-checkbox');
			if (mainCheckbox) {
				mainCheckbox.checked = state.checked || false;
				row.classList.toggle('row-completed', state.checked || false);
			}

			// 2. Repeat Count
			const repeatCell = row.querySelector('.repeat-cell');
			if (repeatCell) {
				repeatCell.textContent = state.repeat || '0';
			}
		});
	});

	updateScoreDisplays();
}

/**
 * ì ìˆ˜ ë””ìŠ¤í”Œë ˆì´ë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤.
 */
function updateScoreDisplays() {
	const wordScoreDisplay = document.getElementById('word-game-score-display');
	const sentenceScoreDisplay = document.getElementById('sentence-game-score-display');
	const questScore = gameScores.quest || '0';

	const lastWordGameScore = gameScores.word || '0';
	if (lastWordGameScore !== '0') {
		wordScoreDisplay.textContent = `ìµœê·¼ ë‹¨ì–´ê²Œì„ ì ìˆ˜: ${lastWordGameScore}ì `;
		wordScoreDisplay.classList.remove('game-hidden');
	}
	
	const lastSentenceGameScore = gameScores.sentence || '0';
	if (lastSentenceGameScore !== '0') {
		sentenceScoreDisplay.textContent = `ìµœê·¼ ë¬¸ì¥ê²Œì„ ì ìˆ˜: ${lastSentenceGameScore}ì `;
		sentenceScoreDisplay.classList.remove('game-hidden');
	}

	// Quest result will be handled in its own end screen logic
}


// ===================================================================================
// ìœ í‹¸ë¦¬í‹° ë° ë°ì´í„° ì²˜ë¦¬ í•¨ìˆ˜
// ===================================================================================

/*
* ìƒë‹¨ ê³ ì • ë°”ì˜ ë†’ì´ë§Œí¼ bodyì˜ padding-topì„ ë™ì ìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.*/
function adjustBodyPadding() {
const mainControls = document.querySelector('.main-controls');
if (mainControls && mainControls.offsetHeight > 0) {
document.body.style.paddingTop = `${mainControls.offsetHeight + 20}px`;
}
}

/*
* ì¶”ê°€ë¨: ëª¨ë“  ì˜¤ë””ì˜¤ íŒŒì¼ì„ ë¯¸ë¦¬ ë¡œë“œí•˜ì—¬ ìºì‹œì— ì €ì¥í•©ë‹ˆë‹¤. (ë”œë ˆì´ ì œê±°)*/
function preloadAllAudio() {
const allData = [...wordData, ...sentenceData];
allData.forEach(item => {
if (item.audioUrl && !audioCache[item.audioUrl]) {
// Audio ê°ì²´ë¥¼ ìƒì„±í•˜ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ë¸Œë¼ìš°ì €ê°€ ë‹¤ìš´ë¡œë“œë¥¼ ì‹œì‘í•¨ (preload)
audioCache[item.audioUrl] = new Audio(item.audioUrl);
}
});
}

/*
* ë¬¸ì¥ ë¬¸ìì—´ì—ì„œ ë‹¨ì–´ë¥¼ ì°¾ì•„ í•˜ì´í¼ë§í¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
* ì‚­ì œ: ë¬¸ì¥-ë‹¨ì–´ í•˜ì´í¼ë§í¬ ìƒì„± ë¡œì§ ì œê±°*/
function createLinkedSentence(sentenceText, wordLookup) {
return sentenceText; // ì›ë³¸ í…ìŠ¤íŠ¸ ë°˜í™˜
}

/*
* WordDataë¥¼ íŒŒì‹±í•˜ì—¬ ëª¨ë“  ë³€í˜• ë‹¨ì–´ì— ëŒ€í•œ ë£©ì—… ë§µì„ ë§Œë“¤ê³ , SentenceDataë¥¼ ì´ìš©í•´ ë°±ë§í¬ë¥¼ ì±„ì›ë‹ˆë‹¤.*/
function initializeWordLookupMap(wordData, sentenceData) {
const wordLookup = new Map();
const flatWordCandidates = [];

wordData.forEach(item => {
const slashParts = item.eng.split('/').map(p => p.trim());

slashParts.forEach(part => {
const matchOptional = part.match(/(.*)\((.*)\)(.*)/); // ê´„í˜¸ í¬í•¨ ë‹¨ì–´ ì²˜ë¦¬ ê°•í™”
if (matchOptional) {
const [, prefix, optional, suffix] = matchOptional;

// Variant 1: With optional part (e.g., 'seasoned')
const variantWith = (prefix + optional + suffix).trim();
if (variantWith.length > 0 && !wordLookup.has(variantWith)) {
wordLookup.set(variantWith, { num: item.num, kor: item.kor, sentences: [] });
flatWordCandidates.push({ eng: variantWith, num: item.num, kor: item.kor });
}

// Variant 2: Without optional part (e.g., 'season')
const variantWithout = (prefix + suffix).trim();
if (variantWithout.length > 0 && !wordLookup.has(variantWithout)) {
wordLookup.set(variantWithout, { num: item.num, kor: item.kor, sentences: [] });
flatWordCandidates.push({ eng: variantWithout, num: item.num, kor: item.kor });
}

} else if (part.length > 0 && !wordLookup.has(part)) {
wordLookup.set(part, { num: item.num, kor: item.kor, sentences: [] });
flatWordCandidates.push({ eng: part, num: item.num, kor: item.kor });
}
});
});

// ë¬¸ì¥ì˜ ë‹¨ì–´ì™€ wordDataì˜ ë‹¨ì–´ë¥¼ ë¹„êµí•˜ì—¬ ì—­ì°¸ì¡°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
flatWordCandidates.sort((a, b) => b.eng.length - a.eng.length);
sentenceData.forEach(sentence => {
flatWordCandidates.forEach(wordItem => {
// ë‹¨ì–´ ê²½ê³„ë¥¼ ì‚¬ìš©í•˜ì—¬ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ë‹¨ì–´ë¥¼ ì°¾ìŠµë‹ˆë‹¤.
const pattern = wordItem.eng.replace(/([.?+^$[\]\\(){}|-])/g, "\\$1").replace(/\s+/g, "\\s+");
const regex = new RegExp(`\\b${pattern}\\b`, 'i'); // \bë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¨ì–´ ê²½ê³„ ì¼ì¹˜

// ë¬¸ì¥ í…ìŠ¤íŠ¸ì—ì„œ ë”°ì˜´í‘œ, ì‰¼í‘œ, ë§ˆì¹¨í‘œ ë“±ì„ ì œê±°í•˜ì—¬ ë” ë„“ê²Œ ì¼ì¹˜ì‹œí‚µë‹ˆë‹¤.
const cleanSentence = sentence.eng.replace(/['".,?!]/g, ' ');

if (regex.test(cleanSentence)) {
const lookupItem = wordLookup.get(wordItem.eng);
if (lookupItem && lookupItem.sentences.indexOf(sentence.num) === -1) {
lookupItem.sentences.push(sentence.num);
}
}
});
});

return wordLookup;
}

/*
* í…Œì´ë¸”ì— ë°ì´í„°ë¥¼ ì±„ìš°ëŠ” ë²”ìš© í•¨ìˆ˜ (Firestoreì—ì„œ ë¡œë“œ í›„ updateUIFromState í˜¸ì¶œ)*/
function populateTable(tableId, data, isWordTable, wordLookup) {
const tableBody = document.querySelector(`#${tableId} tbody`);
tableBody.innerHTML = '';

data.forEach(item => {
const row = document.createElement('tr');
const rowId = `${tableId.split('-')[0]}-${item.num}`;
row.id = rowId;

let mainContentHtml;

// Check if it's the first row for highlighting the 'ë“£ê¸°' cell
const isFirstRow = item.num === 1;
const listenHighlightClass = isFirstRow ? ' highlight-listen-cell' : '';

if (isWordTable) {
// ë‹¨ì–´ í…Œì´ë¸”: 'IMAGE' ì—´(ì´ì „ 'ìˆ¨ê¹€/í‘œì‹œ') ì¶”ê°€ ë° ê¸°ëŠ¥ ì œê±°
mainContentHtml = item.eng;

// ë‹¨ì–´ í…Œì´ë¸” êµ¬ì¡°
row.innerHTML = `<td class="font-10" data-label="ìˆœì„œ">${item.num}</td>
					 <td data-label="ì²´í¬"><input type="checkbox" class="checkbox-15 main-checkbox" title="í•™ìŠµ ì™„ë£Œ ì²´í¬"></td>
					 <td data-label="image-placeholder"></td>
					 <td class="font-15 color-black clickable" data-label="ë‹¨ì–´" title="ë‹¨ì–´ ë³´ê¸°/ìˆ¨ê¸°ê¸°">${mainContentHtml}</td>
					 <td class="font-15 clickable" data-label="ëœ»" title="ëœ» ë³´ê¸°/ìˆ¨ê¸°ê¸°">${item.kor}</td>
					 <td class="clickable font-30${listenHighlightClass}" data-label="ë“£ê¸°" title="ìŒì„± ë“£ê¸°">ğŸ—£ï¸</td>
					 <td class="repeat-cell font-30" data-label="ë°˜ë³µ">0</td>`;

} else {
// ë¬¸ì¥ í…Œì´ë¸”: 'IMAGE' ì—´(ì´ì „ 'ìˆ¨ê¹€/í‘œì‹œ') ì¶”ê°€ ë° ê¸°ëŠ¥ ì œê±°
mainContentHtml = item.eng;

// ë¬¸ì¥ í…Œì´ë¸” êµ¬ì¡°
row.innerHTML = `<td class="font-10" data-label="ìˆœì„œ">${item.num}</td>
					 <td data-label="ì²´í¬"><input type="checkbox" class="checkbox-15 main-checkbox" title="í•™ìŠµ ì™„ë£Œ ì²´í¬"></td>
					 <td data-label="image-placeholder"></td>
					 <td class="font-15 color-black clickable" data-label="ë¬¸ì¥" title="ë¬¸ì¥ ë³´ê¸°/ìˆ¨ê¸°ê¸°">${mainContentHtml}</td>
					 <td class="font-15 clickable" data-label="ëœ»" title="ëœ» ë³´ê¸°/ìˆ¨ê¸°ê¸°">${item.kor}</td>
					 <td class="clickable font-30${listenHighlightClass}" data-label="ë“£ê¸°" title="ìŒì„± ë“£ê¸°">ğŸ—£ï¸</td>
					 <td class="repeat-cell font-30" data-label="ë°˜ë³µ">0</td>`;
}

tableBody.appendChild(row);

// Initial state will be loaded and applied by updateUIFromState after Firestore listener fires
});
}


// --- íƒ€ì´ë¨¸ ìœ í‹¸ë¦¬í‹° ---

function formatTime(seconds) {
const mins = Math.floor(seconds / 60).toString().padStart(2, '0');
const secs = (seconds % 60).toString().padStart(2, '0');
return `${mins}:${secs}`;
}

const timerDisplay = document.getElementById('timer');
function startTimer() {
if (timerInterval) clearInterval(timerInterval);
timerInterval = setInterval(() => {
secondsElapsed++;
timerDisplay.textContent = formatTime(secondsElapsed);
}, 1000);
}

function stopTimer() {
clearInterval(timerInterval);
secondsElapsed = 0;
timerDisplay.textContent = '';
}

function startLearningTimer() {
if (learningTimerInterval) return;
learningTimerInterval = setInterval(() => {
learningSecondsElapsed++;
document.getElementById('learning-timer-display').textContent = formatTime(learningSecondsElapsed);
}, 1000);
}

function stopLearningTimer() {
clearInterval(learningTimerInterval);
learningTimerInterval = null;
}

function resetInactivityTimer() {
if (inactivityTimeout) {
clearTimeout(inactivityTimeout);
}
startLearningTimer();
inactivityTimeout = setTimeout(stopLearningTimer, inactivityDuration);
}


// ===================================================================================
// ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
// ===================================================================================

/**
* ì˜¤ë””ì˜¤ ì¬ìƒ í›„ í•˜ì´ë¼ì´íŠ¸ë¥¼ ë‹¤ìŒ í–‰ìœ¼ë¡œ ì´ë™ì‹œí‚¤ê³ , ë§ˆì§€ë§‰ í–‰ì¼ ê²½ìš° ì²« í–‰ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤.
* @param {HTMLTableRowElement} currentRow í˜„ì¬ í–‰*/
function findNextRowAndHighlight(currentRow) {
const tableBody = currentRow.closest('tbody');
const allRows = Array.from(tableBody.querySelectorAll('tr'));
const currentIndex = allRows.indexOf(currentRow);

// 1. í˜„ì¬ í–‰ì˜ í•˜ì´ë¼ì´íŠ¸ ì œê±°
const currentListenCell = currentRow.querySelector('[data-label="ë“£ê¸°"]');
currentListenCell.classList.remove('highlight-listen-cell');
currentListenCell.classList.remove('no-pointer-events'); // í´ë¦­ ì ê¸ˆ í•´ì œ

let nextRow;
if (currentIndex < allRows.length - 1) {
// 2. ë‹¤ìŒ í–‰ìœ¼ë¡œ ì´ë™
nextRow = allRows[currentIndex + 1];
} else {
// 3. ë§ˆì§€ë§‰ í–‰ì¸ ê²½ìš° ì²« í–‰ìœ¼ë¡œ íšŒê·€
nextRow = allRows[0];
}

// 4. ë‹¤ìŒ í–‰ì— í•˜ì´ë¼ì´íŠ¸ ì¶”ê°€
const nextListenCell = nextRow.querySelector('[data-label="ë“£ê¸°"]');
nextListenCell.classList.add('highlight-listen-cell');

// 5. ìš”ì²­: ìƒˆë¡œ í•˜ì´ë¼ì´íŠ¸ëœ ì…€ë¡œ ìë™ ìŠ¤í¬ë¡¤
nextListenCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
}

/*
* ë°˜ë³µ íšŸìˆ˜ ì´ˆê¸°í™” í•¸ë“¤ëŸ¬ (Firestore ì—…ë°ì´íŠ¸)
* @param {string} tableId ì´ˆê¸°í™”í•  í…Œì´ë¸”ì˜ ID ('word-table' ë˜ëŠ” 'sentence-table')*/
async function handleResetRepeatCount(tableId) {
	if (!db || !userId) return;

	const { writeBatch, doc, collection } = window.firebase.firestore;
	const tableBody = document.querySelector(`#${tableId} tbody`);
	if (!tableBody) return;
	
	const rows = tableBody.querySelectorAll('tr');
	const prefix = tableId.split('-')[0];
	const batch = writeBatch(db);
	
	rows.forEach(row => {
		const rowId = `${prefix}-${row.id.split('-')[1]}`;
		const repeatCell = row.querySelector('.repeat-cell');
		
		// Firestore ì—…ë°ì´íŠ¸ë¥¼ ìœ„í•œ Document Reference ìƒì„±
		const docRef = doc(db, 'artifacts', appId, 'users', userId, 'progress', rowId);
		
		// Batchì— update ì‘ì—… ì¶”ê°€
		batch.set(docRef, { repeat: 0 }, { merge: true });
		
		// í™”ë©´ ì—…ë°ì´íŠ¸ (onSnapshotì—ì„œ ì²˜ë¦¬ë˜ì§€ë§Œ ì¦‰ì‹œ í”¼ë“œë°±ì„ ìœ„í•´ ì„ì‹œë¡œ ì—…ë°ì´íŠ¸)
		repeatCell.textContent = '0';
	});
	
	// Batch ì‹¤í–‰
	try {
		await batch.commit();
		// UIëŠ” onSnapshotì„ í†µí•´ ìµœì¢…ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë  ê²ƒì…ë‹ˆë‹¤.
	} catch (error) {
		console.error("Error resetting repeat counts:", error);
	}

	// ì²« í–‰ìœ¼ë¡œ í•˜ì´ë¼ì´íŠ¸ ì¬ì„¤ì •
	const allRows = Array.from(rows);
	if (allRows.length > 0) {
		// ê¸°ì¡´ í•˜ì´ë¼ì´íŠ¸ ì œê±°
		tableBody.querySelectorAll('.highlight-listen-cell').forEach(cell => {
			cell.classList.remove('highlight-listen-cell');
			cell.classList.remove('no-pointer-events');
		});

		// ì²« í–‰ í•˜ì´ë¼ì´íŠ¸ ì„¤ì •
		const firstListenCell = allRows[0].querySelector('[data-label="ë“£ê¸°"]');
		firstListenCell.classList.add('highlight-listen-cell');
		firstListenCell.scrollIntoView({ behavior: 'smooth', block: 'center' });
	}
}


function toggleTestMode() {
isTestMode = !isTestMode;
const testModeBtn = document.getElementById('test-mode-btn');
const testTypeToggle = document.getElementById('test-type-toggle');
const elementsToHide = document.querySelectorAll('th .switch');
const meaningCells = document.querySelectorAll('td[data-label="ëœ»"]');
const sentenceCells = document.querySelectorAll('#sentence-table td[data-label="ë¬¸ì¥"]');
const wordCells = document.querySelectorAll('#word-table td[data-label="ë‹¨ì–´"]');

if (isTestMode) {
// playStartChime(); // TTS ì œê±°ë¡œ ì¸í•´ ì£¼ì„ ì²˜ë¦¬
startTimer();
testModeBtn.textContent = 'ì‹œí—˜ì¤‘';
testModeBtn.classList.add('testing');
elementsToHide.forEach(toggle => toggle.style.display = 'none');

if (testTypeToggle.checked) { // ì˜ì–´ ì‹œí—˜ (ë¬¸ì œ: í•œê¸€, ë‹µ: ì˜ì–´)
meaningCells.forEach(cell => cell.classList.remove('text-hidden'));
sentenceCells.forEach(cell => cell.classList.add('text-hidden'));
wordCells.forEach(cell => cell.classList.add('text-hidden'));
} else { // í•œê¸€ ì‹œí—˜ (ë¬¸ì œ: ì˜ì–´, ë‹µ: í•œê¸€)
meaningCells.forEach(cell => cell.classList.add('text-hidden'));
sentenceCells.forEach(cell => cell.classList.remove('text-hidden'));
wordCells.forEach(cell => cell.classList.remove('text-hidden'));
}

} else {
// playEndChime(); // TTS ì œê±°ë¡œ ì¸í•´ ì£¼ì„ ì²˜ë¦¬
stopTimer();
testModeBtn.textContent = 'ì‹œí—˜ë³´ê¸°';
testModeBtn.classList.remove('testing');
elementsToHide.forEach(toggle => toggle.style.display = 'inline-block');

// ëª¨ë“  ìˆ¨ê¹€ ìƒíƒœ í•´ì œ (ì‹œí—˜ ëª¨ë“œì—ì„œ ê°•ì œ ìˆ¨ê¹€ í•´ì œ)
meaningCells.forEach(cell => cell.classList.remove('text-hidden'));
sentenceCells.forEach(cell => cell.classList.remove('text-hidden'));
wordCells.forEach(cell => cell.classList.remove('text-hidden'));
}
}


async function handleTableClick(e) {
	const target = e.target;
	const row = target.closest('tr');
	if (!row || row.parentElement.tagName === 'THEAD') return;
	const rowId = row.id;
	const clickedCell = e.target.closest('td');
	if(!clickedCell) return;

	const clickedLabel = clickedCell.getAttribute('data-label');
	const currentState = learningProgress[rowId] || { checked: false, repeat: 0 };


	// 1. Checkbox Toggle (Firestore Update)
	if (target.classList.contains('main-checkbox')) {
		const isChecked = target.checked;
		row.classList.toggle('row-completed', isChecked);
		// Save to Firestore
		await saveLearningProgress(rowId, { checked: isChecked });
		return;
	}

	// 2. Word Link Click (ë‹¨ì–´í‘œì˜ ë¬¸ì¥ ë²ˆí˜¸ ë§í¬ë§Œ í•´ë‹¹)
	const wordLink = e.target.closest('a[href^="#sentence-"]');
	if (wordLink) {
		e.preventDefault();
		if (row.closest('table').id !== 'word-table') return;
		lastScrollY = window.scrollY;
		lastActiveSentenceId = row.id;
		const targetElement = document.querySelector(wordLink.getAttribute('href'));
		if (targetElement) {
			document.querySelectorAll('.highlight-origin').forEach(el => el.classList.remove('highlight-origin'));
			targetElement.classList.add('highlight-origin');
			targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
			document.getElementById('back-btn').title = "ì›ë˜ ë‹¨ì–´ë¡œ ëŒì•„ê°€ê¸°";
			document.getElementById('back-btn').style.display = 'block';
		}
		return;
	}

	// 3. Image Placeholder (No action, skip)
	if (clickedLabel === 'image-placeholder') {
		return;
	}
	
	// 4. ë‹¨ì–´, ë¬¸ì¥, ëœ» ì…€ì„ í´ë¦­í•˜ì—¬ ê°œë³„ ìˆ¨ê¹€/í‘œì‹œ (ê¸°ëŠ¥ ì¶”ê°€/í†µí•©)
	else if (clickedLabel === 'ë‹¨ì–´' || clickedLabel === 'ë¬¸ì¥' || clickedLabel === 'ëœ»') {
		// ì‹œí—˜ ëª¨ë“œ ì¤‘ì—ëŠ” ê°œë³„ ì…€ ìˆ¨ê¹€/í‘œì‹œë¥¼ í—ˆìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Test Modeê°€ ì „ì²´ë¥¼ í†µì œí•¨)
		if (isTestMode) {
			return;
		}
		clickedCell.classList.toggle('text-hidden');
		return;
	}

	// 5. Audio Playback and Progression Logic (Preloaded & Firestore Update)
	else if (clickedLabel === 'ë“£ê¸°') {
		// í´ë¦­ ë°©ì§€ ìƒíƒœì¸ì§€ ë¨¼ì € í™•ì¸
		if (clickedCell.classList.contains('no-pointer-events')) return;

		const isHighlighted = clickedCell.classList.contains('highlight-listen-cell');

		const tableId = row.closest('table').id;
		const itemNum = parseInt(row.id.split('-')[1], 10);
		const dataItem = tableId === 'sentence-table'
			? sentenceData.find(item => item.num === itemNum)
			: wordData.find(item => item.num === itemNum);

		const audioUrl = dataItem?.audioUrl;

		if (audioUrl) {
			const audio = audioCache[audioUrl];
			if (!audio) return;

			const originalContent = clickedCell.textContent;

			// ì—°íƒ€ ë°©ì§€ (ì¬ìƒ ì¤‘ í´ë¦­ ë°©ì§€)
			clickedCell.classList.add('no-pointer-events');

			// ì¬ìƒ ìœ„ì¹˜ ì´ˆê¸°í™” ë° ì¬ìƒ
			audio.currentTime = 0;
			clickedCell.textContent = 'ğŸ”Š'; // Play icon

			audio.onended = async () => {
				clickedCell.textContent = originalContent; // Revert icon

				// 1. Increment Repeat Count (Only if highlighted - Firestore Update)
				if (isHighlighted) {
					const repeatCell = row.querySelector('.repeat-cell');
					// We increment the count based on the current state from Firestore, not the UI
					let currentCount = (learningProgress[rowId]?.repeat || 0) + 1;
					
					// Firestore ì—…ë°ì´íŠ¸ (ë¹„ë™ê¸° ì²˜ë¦¬)
					await saveLearningProgress(rowId, { repeat: currentCount });

					// 2. Move Highlight to next row 
					findNextRowAndHighlight(row); // ì—¬ê¸°ì„œ no-pointer-events í•´ì œë¨
				} else {
					clickedCell.classList.remove('no-pointer-events'); // ë¹„í•˜ì´ë¼ì´íŠ¸ ì…€ì€ ì¬ìƒ ëë‚˜ë©´ ë°”ë¡œ í•´ì œ
				}
			};

			audio.onerror = () => {
				console.error("Audio playback failed (onerror) for:", audioUrl);
				clickedCell.textContent = 'âš ï¸';
				setTimeout(() => {
					clickedCell.textContent = originalContent;
					clickedCell.classList.remove('no-pointer-events'); // ì˜¤ë¥˜ ë°œìƒ ì‹œì—ë„ í•´ì œ
				}, 1000);
			};

			// Playback initiated by direct user gesture
			audio.play().catch(error => {
				console.error("Audio playback failed (catch) - likely Autoplay Policy issue on iOS:", error);
				// ì‚¬ìš©ìì—ê²Œ ì¬ìƒ ì‹¤íŒ¨ë¥¼ ì•Œë¦¼ (ëª¨ë°”ì¼ì—ì„œ ì²˜ìŒ í´ë¦­ ì‹œ í”í•¨)
				clickedCell.textContent = 'âš ï¸';
				setTimeout(() => {
					clickedCell.textContent = originalContent;
					clickedCell.classList.remove('no-pointer-events');
				}, 1000);
			});
		}
		return;
	}
}


function handleHeaderClick(e) {
const header = e.target;
// ìˆ˜ì •: ì‹œí—˜ ëª¨ë“œì—ì„œë„ ìˆ¨ê¹€/í‘œì‹œëŠ” í—ˆìš© -> ì´ì œ ì‹œí—˜ ëª¨ë“œì—ì„œ ìˆ¨ê¹€/í‘œì‹œ í´ë¦­ì€ ë¬´ì‹œ
if (!header.classList.contains('clickable') || header.tagName !== 'TH') return;

// 1. ë°˜ë³µ íšŸìˆ˜ ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ê°ì§€
const resetIcon = e.target.closest('span[id^="reset-"]');
if (resetIcon) {
const tableId = resetIcon.id.includes('word') ? 'word-table' : 'sentence-table';
handleResetRepeatCount(tableId);
return;
}

// 2. ì¼ë°˜ì ì¸ ìˆ¨ê¹€/í‘œì‹œ í—¤ë” í´ë¦­ ë¡œì§ (ì œê±°ë¨: í—¤ë”ì—ì„œ 'clickable' í´ë˜ìŠ¤ì™€ 'ìˆ¨ê¹€/í‘œì‹œ' í…ìŠ¤íŠ¸ ì œê±°)
// ì´ì œ ì´ ë¸”ë¡ì€ 'ë°˜ë³µ ì´ˆê¸°í™”'ê°€ ì•„ë‹Œ ë‹¤ë¥¸ 'clickable' í—¤ë”ê°€ ìƒê²¼ì„ ë•Œë§Œ ì‘ë™í•©ë‹ˆë‹¤.
// (ë‹¨ì–´/ëœ» í† ê¸€ ìŠ¤ìœ„ì¹˜ëŠ” í´ë¦­ ê°€ëŠ¥í•œ THê°€ ì•„ë‹Œ TH ë‚´ë¶€ì˜ INPUT íƒœê·¸ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤)
}


function scrollToSection(id) {
const targetElement = document.getElementById(id);
if (!targetElement) return;

// ë¬¸ì¥ í…Œì´ë¸”ì˜ ê²½ìš° ì´ì „ í˜•ì œ ìš”ì†Œ(í—¤ë”)ë¡œ ìŠ¤í¬ë¡¤, ì„¹ì…˜ì˜ ê²½ìš° h2ë¡œ ìŠ¤í¬ë¡¤
const scrollTarget = (id === 'writing-practice-section' || id === 'cursive-practice-section' || id === 'sentence-table') ?
document.querySelector(`#${id}`).previousElementSibling.querySelector('h2') || document.querySelector(`#${id}`) : document.querySelector(`#${id}`).previousElementSibling;


if (scrollTarget) {
lastScrollY = window.scrollY;
lastActiveSentenceId = null;
lastWritingPracticeY = null;
scrollTarget.scrollIntoView({ behavior: 'smooth', block: 'start' });

const backBtn = document.getElementById('back-btn');
backBtn.title = "ì´ì „ ìœ„ì¹˜ë¡œ ëŒì•„ê°€ê¸°";
backBtn.style.display = 'block';
}
}


function handleBackButtonClick() {
const backBtn = document.getElementById('back-btn');
const highlighted = document.querySelector('.highlight-origin');
if(highlighted) highlighted.classList.remove('highlight-origin');

if (lastActiveSentenceId) {
document.getElementById(lastActiveSentenceId)?.scrollIntoView({ behavior: 'smooth', block: 'center' });
lastActiveSentenceId = null;
} else if (lastScrollY !== null) {
window.scrollTo({ top: lastScrollY, behavior: 'smooth' });
lastScrollY = null;
} else if (lastWritingPracticeY !== null) {
window.scrollTo({ top: lastWritingPracticeY, behavior: 'smooth' });
lastWritingPracticeY = null;
}
backBtn.style.display = 'none';
}


// ===================================================================================
// ì´ˆê¸°í™” ë° ë¦¬ìŠ¤ë„ˆ ì„¤ì •
// ===================================================================================


function setupToggleListeners() {
const columnToggles = [
{ id: 'toggle-sentence-col', selector: '#sentence-table tbody tr td[data-label="ë¬¸ì¥"]' },
{ id: 'toggle-word-col', selector: '#word-table tbody tr td[data-label="ë‹¨ì–´"]' },
{ id: 'toggle-sentence-meaning-col', selector: '#sentence-table tbody tr td[data-label="ëœ»"]' },
{ id: 'toggle-word-meaning-col', selector: '#word-table tbody tr td[data-label="ëœ»"]' },
];

columnToggles.forEach(t => {
const toggleEl = document.getElementById(t.id);
if (toggleEl) {
// --- ì˜¤ë¥˜ ìˆ˜ì •: ë‹«ëŠ” ê´„í˜¸ì™€ ì¤‘ê´„í˜¸ ì¶”ê°€ ---
toggleEl.addEventListener('change', function() {
const cells = document.querySelectorAll(t.selector);
cells.forEach(cell => {
this.checked ? cell.classList.add('text-hidden') : cell.classList.remove('text-hidden');
});
});
// ----------------------------------------
}
});
}


function setupGlobalEventListeners() {
// Navigation/Scroll Controls
document.getElementById('home-btn').addEventListener('click', () => { window.scrollTo({ top: 0, behavior: 'smooth' }); });
document.getElementById('sentence-learning-btn').addEventListener('click', () => scrollToSection('sentence-table'));
document.getElementById('writing-practice-btn').addEventListener('click', () => scrollToSection('writing-practice-section'));
document.getElementById('back-btn').addEventListener('click', handleBackButtonClick);

// Table/Interactivity Controls
document.getElementById('sentence-table').addEventListener('click', handleTableClick);
document.getElementById('word-table').addEventListener('click', handleTableClick);
document.querySelectorAll('th.clickable').forEach(header => { header.addEventListener('click', handleHeaderClick); });

// ì¶”ê°€: ë°˜ë³µ íšŸìˆ˜ ì´ˆê¸°í™” ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
document.getElementById('reset-word-repeat').addEventListener('click', () => handleResetRepeatCount('word-table'));
document.getElementById('reset-sentence-repeat').addEventListener('click', () => handleResetRepeatCount('sentence-table'));

// Toggles and Test Mode
document.getElementById('test-mode-btn').addEventListener('click', toggleTestMode);
setupToggleListeners();

// Practice Section Links (Delegated Event)
document.querySelectorAll('.practice-section').forEach(section => {
section.addEventListener('click', (e) => {
// ì‚­ì œ: ë¬¸ì¥í‘œì˜ í•˜ì´í¼ë§í¬ ê¸°ëŠ¥ ì œê±°ì— ë”°ë¼, ë¬¸ì¥í‘œ ë§í¬ í´ë¦­ ì²˜ë¦¬ ë¡œì§ ì œê±°
const link = e.target.closest('a');
if (!link || !link.getAttribute('href')?.startsWith('#')) return;
e.preventDefault();

const targetElement = document.querySelector(link.getAttribute('href'));
if (targetElement) {
lastWritingPracticeY = window.scrollY;
lastActiveSentenceId = null;
lastScrollY = null;
targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
document.getElementById('back-btn').title = "ì“°ê¸° ì„¹ì…˜ìœ¼ë¡œ ëŒì•„ê°€ê¸°";
document.getElementById('back-btn').style.display = 'block';
}
});
});

// Game/Quest Controls
document.getElementById('word-game-btn').addEventListener('click', () => startGame('word'));
document.getElementById('sentence-game-btn').addEventListener('click', () => startGame('sentence'));
document.getElementById('game-audio-btn').addEventListener('click', handleGameAudioClick); // NEW: ê²Œì„ ì˜¤ë””ì˜¤ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ
document.querySelectorAll('.answer-option').forEach(option => { option.addEventListener('click', selectAnswer); });
document.getElementById('return-to-main-btn').addEventListener('click', returnToMain);
document.getElementById('exit-game-btn').addEventListener('click', exitGame);

document.getElementById('pronunciation-quest-btn').addEventListener('click', startPronunciationQuest);
document.getElementById('accept-quest-btn').addEventListener('click', () => {
document.getElementById('quest-king-screen').classList.add('game-hidden');
document.getElementById('quest-ui').classList.remove('game-hidden');
showNextQuestWord();
});
document.getElementById('exit-quest-btn').addEventListener('click', exitQuest);
document.getElementById('return-to-main-from-quest-btn').addEventListener('click', exitQuest);

// ë‹ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ ì˜¤ë””ì˜¤ ì¬ìƒ ê¸°ëŠ¥
document.getElementById('quest-mic-btn').addEventListener('click', handleQuestCheckClick);

document.getElementById('quest-correct-btn').addEventListener('click', () => handleSelfAssessment(true));
document.getElementById('quest-incorrect-btn').addEventListener('click', () => handleSelfAssessment(false));

// Activity Timer
document.addEventListener('mousedown', resetInactivityTimer);
document.addEventListener('keydown', resetInactivityTimer);
document.addEventListener('touchstart', resetInactivityTimer);
document.addEventListener('scroll', resetInactivityTimer);
}

/*
* ìˆ˜ì •ë¨: ë‹ë³´ê¸° ì•„ì´ì½˜ í´ë¦­ ì‹œ í•´ë‹¹ ë‹¨ì–´ ì˜¤ë””ì˜¤ ì¬ìƒ í›„, O/X ë²„íŠ¼ ë…¸ì¶œ*/
function handleQuestCheckClick() {
const micBtn = document.getElementById('quest-mic-btn');
const feedbackEl = document.getElementById('quest-feedback');
const controls = document.getElementById('quest-controls');
const guardianMessagebox = document.getElementById('quest-message-box');

// 1. Get current word/audio info
const currentWord = questWords[questQuestionCount];
const audioUrl = currentWord?.audioUrl;

if (!audioUrl) {
guardianMessagebox.textContent = "ì˜¤ë””ì˜¤ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
return;
}

// ìºì‹œëœ Audio ê°ì²´ë¥¼ ì‚¬ìš©
const audio = audioCache[audioUrl];
if (audio) {
const originalIcon = micBtn.textContent; // ğŸ”
micBtn.disabled = true;
micBtn.textContent = 'ğŸ”Š'; // Playing icon
micBtn.classList.add('playing'); // Use existing pulse animation

// ì¬ìƒ ìœ„ì¹˜ ì´ˆê¸°í™” (Preloadì˜ í•µì‹¬)
audio.currentTime = 0;

audio.onended = async () => {
micBtn.classList.remove('playing');
micBtn.textContent = originalIcon; // Revert to ğŸ”
micBtn.disabled = false; // Next word handles its own disabled state

// Show self-assessment controls after audio ends
feedbackEl.textContent = "ë°œìŒì„ ë”°ë¼í•´ë³´ê³ , ë§ê²Œ ë°œìŒí–ˆëŠ”ì§€ ìŠ¤ìŠ¤ë¡œ í‰ê°€í•´ì£¼ì„¸ìš”.";
guardianMessagebox.textContent = "ë°œìŒì´ í‹€ë ¸ëŠ”ë°ë„ Oë¥¼ ëˆ„ë¥´ë©´ ëª¬ìŠ¤í„°ê°€ ê¸ˆìƒˆ í’€ë ¤ë‚  ìˆ˜ ìˆì–´ìš”.";
controls.classList.remove('game-hidden');
micBtn.classList.add('game-hidden');
};

audio.onerror = () => {
console.error("Audio playback failed (onerror) for:", audioUrl);
micBtn.classList.remove('playing');
micBtn.textContent = 'âŒ';
micBtn.disabled = false;
guardianMessagebox.textContent = "ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜! ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.";
setTimeout(() => { micBtn.textContent = originalIcon; }, 1000);
};

audio.play().catch(error => {
console.error("Audio playback failed (catch) - likely Autoplay Policy issue on iOS:", error);
micBtn.classList.remove('playing');
micBtn.textContent = 'âš ï¸';
micBtn.disabled = false;
guardianMessagebox.textContent = "ì˜¤ë””ì˜¤ ì¬ìƒì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (í´ë¦­ í›„ ì¬ìƒ ì •ì±… í™•ì¸)";
setTimeout(() => { micBtn.textContent = originalIcon; }, 1000);
});
}
}

// NEW: ê²Œì„ ëª¨ë“œì—ì„œ ìˆ˜ë™ ì˜¤ë””ì˜¤ ì¬ìƒ í•¨ìˆ˜
function handleGameAudioClick(e) {
    const btn = e.target;
    const audioUrl = btn.getAttribute('data-audio-url');

    if (!audioUrl || btn.disabled) return;

    const audio = audioCache[audioUrl];
    if (audio) {
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = '... ì¬ìƒ ì¤‘ ...';
        
        audio.currentTime = 0;
        
        audio.onended = () => {
            btn.textContent = originalText;
            btn.disabled = false;
        };

        audio.onerror = () => {
            console.error("Game Audio playback failed (onerror):", audioUrl);
            btn.textContent = 'âš ï¸ ì˜¤ë¥˜';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 1000);
        };

        // Playback initiated by direct user gesture
        audio.play().catch(error => {
            console.error("Game Audio playback failed (catch):", error);
            btn.textContent = 'âš ï¸ ì¬ìƒ ì‹¤íŒ¨';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 1000);
        });
    }
}


document.addEventListener('DOMContentLoaded', async () => {
// 1. UI Setup
adjustBodyPadding();
window.addEventListener('resize', adjustBodyPadding);

// 2. Data Initialization & Audio Preload
wordLookupMap = initializeWordLookupMap(wordData, sentenceData);
preloadAllAudio();

// 3. Table Population (Initial rendering with default state)
populateTable('sentence-table', sentenceData, false, wordLookupMap);
populateTable('word-table', wordData, true, wordLookupMap);

// 4. Writing Practice Population (Modified to use the 'paragraph' field)
const paragraphsContainer = document.getElementById('writing-paragraphs');
// 4-1. Group sentences by paragraph field
const paragraphs = sentenceData.reduce((acc, sentence) => {
    const pKey = sentence.paragraph;
    if (!acc[pKey]) {
        acc[pKey] = [];
    }
    acc[pKey].push(sentence);
    return acc;
}, {});

// 4-2. Iterate over grouped paragraphs and render
let paragraphsHtml = '';
for (const pKey in paragraphs) {
    const chunk = paragraphs[pKey];
    let currentParagraph = '<p class="handwriting-paragraph">';
    chunk.forEach(sentence => {
        currentParagraph += `<sup><a href="#sentence-${sentence.num}" title="${sentence.num}ë²ˆ ë¬¸ì¥ìœ¼ë¡œ ì´ë™">${sentence.num}</a></sup> ${sentence.eng} `;
    });
    currentParagraph += '</p>';
    paragraphsHtml += currentParagraph;
}

document.getElementById('writing-paragraphs').innerHTML = paragraphsHtml;
document.getElementById('cursive-paragraphs').innerHTML = paragraphsHtml; // Cursive uses the same content

// 5. Global Event Listeners Setup
setupGlobalEventListeners();

// 6. Firebase Initialization and Data Fetching (Triggers updateUIFromState)
await initializeFirebase();

// 7. Timer Initialization
document.getElementById('learning-timer-display').textContent = formatTime(learningSecondsElapsed);
resetInactivityTimer();
});


// ===================================================================================
// Game/Quest Functions
// ===================================================================================


function startGame(gameType) {
currentGameType = gameType;
currentGameTimeLimit = (currentGameType === 'word') ? 4 : 7;
isEngTestMode = document.getElementById(`${gameType}-game-test-type-toggle`).checked;
document.body.classList.add('main-content-hidden');
const [gameOverlay, introScreen, gameUi, gameResultScreen] = ['game-overlay', 'game-intro-screen', 'game-ui', 'game-result-screen'].map(id => document.getElementById(id));

gameOverlay.classList.remove('game-hidden');
introScreen.classList.remove('game-hidden');
gameUi.classList.add('game-hidden');
gameResultScreen.classList.add('game-hidden');

currentGameScore = 0;
currentQuestionIndex = 0;
consecutiveWrongAnswers = 0;
incorrectQueue = [];
difficultyPoolIndex = 0;

const sourceData = (gameType === 'word') ? wordData : sentenceData;
shuffledData = [...sourceData].sort(() => Math.random() - 0.5);
totalQuestionsTarget = (sourceData.length * 2 > 30) ? sourceData.length * 2 : 30; // ì§ˆë¬¸ ëª©í‘œë¥¼ ë°ì´í„° ê¸¸ì´ì˜ 2ë°° ë˜ëŠ” ìµœì†Œ 30ìœ¼ë¡œ ì„¤ì •
difficultyPool = [...sourceData].sort((a, b) => a.eng.replace(/<[^>]+>/g, '').length - b.eng.replace(/<[^>]+>/g, '').length);

swimmerPosition = 75;
sharkPosition = 10;
document.getElementById('swimmer').style.left = `${swimmerPosition}%`;
document.getElementById('shark').style.left = `${sharkPosition}%`;
document.getElementById('game-score').textContent = `Score: ${currentGameScore}`;

setTimeout(() => {
introScreen.classList.add('game-hidden');
gameUi.classList.remove('game-hidden');
showNextQuestion();
}, 2500);
}


function showNextQuestion() {
const answerOptions = document.querySelectorAll('.answer-option');
answerOptions.forEach(opt => {
opt.classList.remove('correct', 'incorrect', 'no-click');
});

// ì§ˆë¬¸ì´ ëª©í‘œì¹˜ì— ë„ë‹¬í–ˆê±°ë‚˜ ë°ì´í„°ê°€ ë¶€ì¡±í•˜ë©´ ì¢…ë£Œ
if (currentQuestionIndex >= totalQuestionsTarget || shuffledData.length === 0) {
endGame(true);
return;
}

let currentItem;
if (currentQuestionIndex < shuffledData.length) {
currentItem = shuffledData[currentQuestionIndex];
} else if (incorrectQueue.length > 0) {
currentItem = incorrectQueue.shift();
shuffledData.push(currentItem); // ë‹¤ì‹œ ì…”í”Œëœ ë°ì´í„°ì˜ ëì— ì¶”ê°€
} else {
// ì˜¤ë‹µ íë„ ë¹„ì–´ìˆìœ¼ë©´ ì‰¬ìš´ ë¬¸ì œë¡œ ëŒì•„ê°
currentItem = difficultyPool[difficultyPoolIndex++ % difficultyPool.length];
shuffledData.push(currentItem);
}

let questionText = isEngTestMode ? currentItem.kor : currentItem.eng.split('/')[0].trim().replace(/\(.\)/g, ''); // ë‹¨ì–´ì˜ ê²½ìš° / ì´í›„ì˜ ë‚´ìš© ì œê±°, ë¬¸ì¥ì˜ ê²½ìš° ì „ì²´

document.getElementById('game-question').textContent = questionText;
document.getElementById('game-progress').textContent = `${currentQuestionIndex + 1} / ${totalQuestionsTarget}`;

// --- ê²Œì„ ì˜¤ë””ì˜¤ ì¬ìƒ ë¡œì§ ìˆ˜ì •: ìë™ ì¬ìƒ ì œê±°, ë²„íŠ¼ í‘œì‹œ ---
const gameAudioBtn = document.getElementById('game-audio-btn');
const audioUrl = currentItem?.audioUrl;

if (audioUrl && !isEngTestMode) { // ì˜ì–´ ë‹¨ì–´/ë¬¸ì¥ì¼ ë•Œë§Œ ì˜¤ë””ì˜¤ ë²„íŠ¼ í‘œì‹œ
    gameAudioBtn.style.display = 'block';
    gameAudioBtn.disabled = false;
    gameAudioBtn.textContent = 'ğŸ”Š ë“£ê¸°';
    gameAudioBtn.setAttribute('data-audio-url', audioUrl);
} else {
    gameAudioBtn.style.display = 'none';
}
// --- End Game Audio Logic ---

const answers = generateAnswers(currentItem, isEngTestMode);
answerOptions.forEach((option, index) => {
option.textContent = answers[index];
});

gameTimeLeft = currentGameTimeLimit;
document.getElementById('game-timer').textContent = gameTimeLeft;
if (gameTimerInterval) clearInterval(gameTimerInterval);
gameTimerInterval = setInterval(updateGameTimer, 1000);
}


function updateGameTimer() {
gameTimeLeft--;
document.getElementById('game-timer').textContent = gameTimeLeft;
if (gameTimeLeft <= 0) {
clearInterval(gameTimerInterval);
handleAnswer(null);
}
}


function generateAnswers(correctItem, isEngTest) {
const distractors = new Set();
const sourceData = (currentGameType === 'word') ? wordData : sentenceData;

// Clean up the correct answer for display/comparison
let correctAnswer;
if (isEngTest) {
correctAnswer = correctItem.eng.split('/')[0].trim().replace(/\(.\)/g, '');
} else {
correctAnswer = correctItem.kor;
}

// Clean up all options for the pool
let allOptions;
if (isEngTest) {
allOptions = sourceData.map(item => item.eng.split('/')[0].trim().replace(/\(.\)/g, ''));
} else {
allOptions = sourceData.map(item => item.kor);
}

while(distractors.size < 3) {
const randomOption = allOptions[Math.floor(Math.random() * allOptions.length)];
if (randomOption !== correctAnswer) {
distractors.add(randomOption);
}
}

const answers = [correctAnswer, ...distractors];
return answers.sort(() => Math.random() - 0.5);
}


function selectAnswer(e) {
clearInterval(gameTimerInterval);
const selectedText = e.target.textContent;
handleAnswer(selectedText, e.target);
}


function handleAnswer(selectedText, selectedOptionEl = null) {
const currentItem = shuffledData[currentQuestionIndex];
let primaryEngWord = currentItem.eng.split('/')[0].trim().replace(/\(.\)/g, '');
let correctKorMeaning = currentItem.kor;
let isCorrect = isEngTestMode ? (selectedText === primaryEngWord) : (selectedText === correctKorMeaning);

const answerOptions = document.querySelectorAll('.answer-option');
answerOptions.forEach(opt => {
opt.classList.add('no-click');
const correctOptionText = isEngTestMode ? primaryEngWord : correctKorMeaning;
if (opt.textContent === correctOptionText) {
opt.classList.add('correct');
}
});

if(selectedOptionEl && !isCorrect) {
selectedOptionEl.classList.add('incorrect');
}

if(isCorrect) {
consecutiveWrongAnswers = 0;
swimmerPosition += 4;
const points = 500 + Math.round((gameTimeLeft / currentGameTimeLimit) * 500);
currentGameScore += points;
} else {
// í‹€ë¦° ë¬¸ì œ 2ë²ˆ ë°˜ë³µ (ì˜¤ë‹µ íì— ì¶”ê°€)
incorrectQueue.push(currentItem, currentItem);
totalQuestionsTarget += 2;
currentGameScore = Math.max(0, currentGameScore - 1000);
consecutiveWrongAnswers++;
sharkPosition += 15;
}

document.getElementById('game-score').textContent = `Score: ${currentGameScore}`;

// Keep elements within bounds after large moves
if (swimmerPosition > 90) {
const panAmount = swimmerPosition - 70;
swimmerPosition -= panAmount;
sharkPosition = Math.max(5, sharkPosition - panAmount);
}

document.getElementById('swimmer').style.left = `${swimmerPosition}%`;
document.getElementById('shark').style.left = `${sharkPosition}%`;

const distance = swimmerPosition - sharkPosition;
const swimmerEl = document.getElementById('swimmer');
swimmerEl.style.filter =
distance > 50 ? 'drop-shadow(0 0 10px #DCDCDC)' :
distance > 30 ? 'drop-shadow(0 0 10px #1E93AB)' :
'drop-shadow(0 0 10px #E62727)';

if (sharkPosition >= swimmerPosition || consecutiveWrongAnswers >= 4) {
setTimeout(() => endGame(false), 500);
return;
}

currentQuestionIndex++;

if (currentQuestionIndex >= totalQuestionsTarget) {
setTimeout(() => endGame(true), 2000);
return;
}

setTimeout(showNextQuestion, 2000);
}


function endGame(didWin) {
if(gameTimerInterval) clearInterval(gameTimerInterval);
document.getElementById('game-ui').classList.add('game-hidden');
const resultScreen = document.getElementById('game-result-screen');
resultScreen.classList.remove('game-hidden');
document.getElementById('final-score').textContent = currentGameScore;

document.getElementById('game-result-title').textContent = didWin ? "íƒˆì¶œ ì„±ê³µ! ğŸ‰" : "ìƒì–´ì—ê²Œ ì¡í˜”ì–´ìš”... ğŸ˜¨";
// ì ìˆ˜ ì €ì¥ (Firestore Update)
const scoreKey = (currentGameType === 'word') ? 'word' : 'sentence';
saveGameScore(scoreKey, currentGameScore);
}


function returnToMain() {
document.body.classList.remove('main-content-hidden');
document.getElementById('game-overlay').classList.add('game-hidden');

const scoreKey = (currentGameType === 'word') ? 'word' : 'sentence';
const scoreDisplayId = (currentGameType === 'word') ? 'word-game-score-display' : 'sentence-game-score-display';

const lastScore = gameScores[scoreKey] || '0'; // Load from global state which is synced with Firestore
const scoreDisplay = document.getElementById(scoreDisplayId);
scoreDisplay.textContent = `ìµœê·¼ ${currentGameType === 'word' ? 'ë‹¨ì–´' : 'ë¬¸ì¥'}ê²Œì„ ì ìˆ˜: ${lastScore}ì `;
scoreDisplay.classList.remove('game-hidden');
}


function exitGame() {
if(gameTimerInterval) clearInterval(gameTimerInterval);
document.body.classList.remove('main-content-hidden');
document.getElementById('game-overlay').classList.add('game-hidden');
}


function startPronunciationQuest() {
document.body.classList.add('main-content-hidden');
const [questOverlay, kingScreen, questUi, resultScreen] = ['pronunciation-quest-overlay', 'quest-king-screen', 'quest-ui', 'quest-result-screen'].map(id => document.getElementById(id));

questOverlay.classList.remove('game-hidden');
kingScreen.classList.remove('game-hidden');
questUi.classList.add('game-hidden');
resultScreen.classList.add('game-hidden');

// Update for new word count
document.getElementById('king-speech-bubble').textContent = `${wordData.length}ë§ˆë¦¬ì˜ ëª¬ìŠ¤í„°ë¥¼ ì¡ì•„ì˜¤ê²Œ! ë¶€íƒí•˜ê² ë„¤!`;

questScore = 0;
questQuestionCount = 0;
monstersCaught = 0;
questWords = [...wordData].sort(() => 0.5 - Math.random());
document.getElementById('quest-progress').textContent = `ì¡ì€ ëª¬ìŠ¤í„° ìˆ˜: ${monstersCaught}/${wordData.length}`;
}


function showNextQuestWord() {
const monsterEl = document.getElementById('monster');
const guardianMessagebox = document.getElementById('quest-message-box');
const micBtn = document.getElementById('quest-mic-btn');

// í€˜ìŠ¤íŠ¸ ì¢…ë£Œ ì¡°ê±´ í™•ì¸ (ëª¨ë“  ë‹¨ì–´ë¥¼ í•œë²ˆì”©ì€ ì²˜ë¦¬í•´ì•¼ í•¨)
if (questQuestionCount >= questWords.length && monstersCaught >= wordData.length) {
endPronunciationQuest();
return;
}

// í˜„ì¬ í€˜ìŠ¤íŠ¸ ì§„í–‰ ì¤‘ì¸ ë‹¨ì–´
const currentWord = questWords[questQuestionCount];
if (!currentWord) {
endPronunciationQuest();
return;
}

// Reset monster animation state
monsterEl.style.transition = 'opacity 0.5s';
monsterEl.style.opacity = '0';
monsterEl.style.left = '100%';

setTimeout(() => {
monsterEl.textContent = monsters[Math.floor(Math.random() * monsters.length)];
monsterEl.style.transition = 'left 0.5s ease-out, opacity 0.5s ease-out';
monsterEl.style.transform = 'translateY(-50%) scaleX(-1)';
monsterEl.style.left = '80%';
monsterEl.style.opacity = '1';

// í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸: ì´ì œ ì˜¤ë””ì˜¤ ë“£ê¸°ê°€ ì£¼ìš” ì•¡ì…˜ì´ë¯€ë¡œ ë©”ì‹œì§€ ë³€ê²½
guardianMessagebox.textContent = "ëª¬ìŠ¤í„° ì´ë¦„(ë‹¨ì–´)ì„ ë“£ê³  ë°œìŒì„ ë”°ë¼í•´ ë´…ì‹œë‹¤. ë‹ë³´ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.";
}, 500);

let displayWord = currentWord.eng.split('/')[0].trim().replace(/\(.\)/g, '');

document.getElementById('quest-word-display').textContent = displayWord;
document.getElementById('quest-progress').textContent = `ì¡ì€ ëª¬ìŠ¤í„° ìˆ˜: ${monstersCaught}/${wordData.length}`;
document.getElementById('quest-feedback').textContent = "";

document.getElementById('quest-controls').classList.add('game-hidden');
micBtn.classList.remove('game-hidden');
micBtn.disabled = false;
}


function playAttackAnimation(isCorrect) {
const guardian = document.getElementById('guardian');
const guardianAttack = document.getElementById('guardian-attack');
const monsterAttack = document.getElementById('monster-attack');
const monsterEl = document.getElementById('monster');

if (isCorrect) {
guardian.classList.add('sparkling');
guardianAttack.style.animation = 'none';
void guardianAttack.offsetWidth;
guardianAttack.style.animation = 'guardian-attack-anim 0.5s ease-out forwards';

monsterEl.style.transition = 'left 2s, transform 2s, opacity 2s';
monsterEl.style.left = 'calc(20% - 40px)';
monsterEl.style.transform = 'translateY(-50%) scale(0.1) rotate(720deg) scaleX(-1)';
monsterEl.style.opacity = '0';

} else {
monsterAttack.style.animation = 'none';
void monsterAttack.offsetWidth;
monsterAttack.style.animation = 'monster-attack-anim 0.5s ease-out forwards';
}
}


function handleSelfAssessment(isCorrect) {
const feedbackEl = document.getElementById('quest-feedback');
const controls = document.getElementById('quest-controls');
const guardian = document.getElementById('guardian');
const guardianMessagebox = document.getElementById('quest-message-box');

controls.classList.add('game-hidden');

if (isCorrect) {
monstersCaught++;
questScore += 100;
feedbackEl.textContent = "ëª¬ìŠ¤í„° íšë“ì— ì„±ê³µí•˜ì˜€ìŠµë‹ˆë‹¤!";
feedbackEl.className = "feedback-success";
guardianMessagebox.textContent = "ì„±ê³µ!";
playAttackAnimation(true);
} else {
feedbackEl.textContent = "ì•„ì‰½ì§€ë§Œ ë‹¤ì‹œ ì‹œë„í•˜ì!!";
feedbackEl.className = "feedback-fail";
guardianMessagebox.textContent = "ì•„ì‰½ì§€ë§Œ í•œ ë²ˆ ë” ì‹œë„í•´ë³´ì.";
// Failed word goes back into the queue 3 steps later (so it's repeated soon)
const failedWord = questWords[questQuestionCount];
// Ensure we don't insert out of bounds
const insertIndex = Math.min(questQuestionCount + 3, questWords.length);
questWords.splice(insertIndex, 0, failedWord);
}

questQuestionCount++;

setTimeout(() => {
guardian.classList.remove('sparkling');
showNextQuestWord();
}, 2000);
}


function endPronunciationQuest() {
document.getElementById('quest-ui').classList.add('game-hidden');
const resultScreen = document.getElementById('quest-result-screen');
resultScreen.classList.remove('game-hidden');
document.getElementById('final-quest-score').textContent = questScore;
document.getElementById('quest-result-title').textContent = "í€˜ìŠ¤íŠ¸ ì™„ë£Œ!";
// ì ìˆ˜ ì €ì¥ (Firestore Update)
saveGameScore('quest', questScore);
}


function exitQuest() {
document.body.classList.remove('main-content-hidden');
document.getElementById('pronunciation-quest-overlay').classList.add('game-hidden');
}

</script>

</body>
</html>
